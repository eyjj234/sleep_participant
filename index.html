<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê¸°ê¸° ì¶”ì  ëŒ€ì‹œë³´ë“œ</title>
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont,
          "SF Pro Text", "Helvetica Neue", sans-serif;
        background: #f5f5f7;
        padding: 12px;
        min-height: 100vh;
        color: #1d1d1f;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      h1 {
        color: #1d1d1f;
        margin-bottom: 20px;
        font-size: 1.5em;
        font-weight: 600;
        letter-spacing: -0.02em;
        display: inline-block;
      }

      .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .stats-text {
        font-size: 0.85em;
        color: #86868b;
        text-align: right;
        line-height: 1.6;
      }

      .stats-text span {
        color: #1d1d1f;
        font-weight: 600;
      }

      .config-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        border: 1px solid #d2d2d7;
        margin-bottom: 30px;
      }

      .config-section h2 {
        color: #1d1d1f;
        margin-bottom: 20px;
        font-size: 1.5em;
        font-weight: 600;
      }

      .input-group {
        margin-bottom: 16px;
      }

      .input-group label {
        display: block;
        margin-bottom: 6px;
        color: #1d1d1f;
        font-size: 0.9em;
        font-weight: 500;
      }

      .input-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        font-size: 0.95em;
        background: white;
      }

      .input-group input:focus {
        outline: none;
        border-color: #86868b;
      }

      button {
        background: #1d1d1f;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      button:hover {
        opacity: 0.8;
      }

      button:disabled {
        background: #d2d2d7;
        cursor: not-allowed;
        opacity: 1;
      }

      .devices-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 30px;
      }

      .device-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #d2d2d7;
        position: relative;
      }

      .device-card.warning {
        background: #fafafa;
      }

      .device-card.danger {
        background: #f5f5f7;
      }

      .device-card.ok {
        background: white;
      }

      .device-group {
        background: white;
        padding: 12px 16px;
        border-radius: 6px;
        border: 1px solid #d2d2d7;
        margin-bottom: 8px;
      }

      .device-group-header {
        font-size: 1em;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #f5f5f7;
      }

      .device-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
      }

      .device-item {
        padding: 8px 10px;
        background: #fafafa;
        border-radius: 4px;
      }

      .device-item-type {
        font-size: 0.7em;
        color: #86868b;
        font-weight: 500;
        margin-bottom: 3px;
      }

      .device-item-id {
        font-size: 0.85em;
        font-weight: 500;
        color: #1d1d1f;
        margin-bottom: 6px;
      }

      .device-item-info {
        font-size: 0.72em;
        color: #86868b;
        margin: 2px 0;
      }

      .device-type {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 500;
        margin-bottom: 10px;
        background: #f5f5f7;
        color: #86868b;
        border: 1px solid #d2d2d7;
      }

      .type-android {
        background: #f5f5f7;
        color: #86868b;
      }

      .type-watch {
        background: #f5f5f7;
        color: #86868b;
      }

      .device-id {
        font-size: 1.1em;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 5px;
      }

      .device-owner {
        font-size: 1.3em;
        color: #1d1d1f;
        margin: 10px 0;
        font-weight: 600;
      }

      .device-info {
        color: #86868b;
        margin: 8px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9em;
      }

      .device-info strong {
        color: #1d1d1f;
        min-width: 80px;
        font-weight: 500;
      }

      .days-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.75em;
        border: 1px solid #d2d2d7;
      }

      .days-ok {
        background: #f5f5f7;
        color: #86868b;
      }

      .days-warning {
        background: #f5f5f7;
        color: #1d1d1f;
        border-color: #86868b;
      }

      .days-danger {
        background: #1d1d1f;
        color: white;
        border-color: #1d1d1f;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 500;
        background: #f5f5f7;
        color: #86868b;
        border: 1px solid #d2d2d7;
      }

      .status-active {
        background: #f5f5f7;
        color: #86868b;
      }

      .status-shipping {
        background: #f5f5f7;
        color: #86868b;
      }

      .error-message {
        background: white;
        color: #1d1d1f;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        border: 1px solid #d2d2d7;
        border-left: 3px solid #1d1d1f;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #86868b;
        font-size: 1.1em;
      }

      .history-section {
        background: white;
        padding: 16px;
        border-radius: 6px;
        border: 1px solid #d2d2d7;
        margin-top: 12px;
      }

      .history-section h2 {
        color: #1d1d1f;
        margin-bottom: 12px;
        font-size: 1em;
        font-weight: 600;
      }

      .history-table {
        width: 100%;
        border-collapse: collapse;
      }

      .history-table th {
        background: #f5f5f7;
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #d2d2d7;
        color: #1d1d1f;
        font-weight: 500;
        font-size: 0.75em;
      }

      .history-table td {
        padding: 8px;
        border-bottom: 1px solid #f5f5f7;
        color: #86868b;
        font-size: 0.75em;
      }

      .history-table tr:hover {
        background: #fafafa;
      }

      .last-updated {
        text-align: center;
        color: #86868b;
        margin-top: 20px;
        font-size: 0.85em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header-section">
        <h1>ğŸ“± ê¸°ê¸° ì¶”ì  ëŒ€ì‹œë³´ë“œ</h1>
        <div id="statsText" class="stats-text" style="display: none"></div>
      </div>

      <div id="configSection" class="config-section">
        <h2>ğŸ”§ Google Sheets ì„¤ì •</h2>
        <div class="input-group">
          <label for="spreadsheetId">Spreadsheet ID:</label>
          <input
            type="text"
            id="spreadsheetId"
            placeholder="1AbC...XyZ í˜•íƒœì˜ ID"
          />
        </div>
        <div class="input-group">
          <label for="apiKey">Google Sheets API Key:</label>
          <input type="text" id="apiKey" placeholder="AIza... í˜•íƒœì˜ API í‚¤" />
        </div>
        <div class="input-group">
          <label for="historySheetName">íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ ì´ë¦„:</label>
          <input
            type="text"
            id="historySheetName"
            placeholder="ì˜ˆ: ì´ë™_íˆìŠ¤í† ë¦¬"
            value="ì´ë™_íˆìŠ¤í† ë¦¬"
          />
        </div>
        <button onclick="saveConfig()">ì €ì¥í•˜ê³  ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <p style="margin-top: 15px; color: #666; font-size: 0.9em">
          â„¹ï¸ <strong>API í‚¤ ë°œê¸‰ ë°©ë²•:</strong><br />
          1.
          <a
            href="https://console.cloud.google.com/apis/credentials"
            target="_blank"
            >Google Cloud Console</a
          >
          ì ‘ì†<br />
          2. í”„ë¡œì íŠ¸ ìƒì„± (ë˜ëŠ” ì„ íƒ)<br />
          3. "API ë° ì„œë¹„ìŠ¤" â†’ "ë¼ì´ë¸ŒëŸ¬ë¦¬" â†’ "Google Sheets API" ê²€ìƒ‰ â†’ ì‚¬ìš©
          ì„¤ì •<br />
          4. "ì‚¬ìš©ì ì¸ì¦ ì •ë³´" â†’ "+ ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ë§Œë“¤ê¸°" â†’ "API í‚¤"<br />
          5. ìƒì„±ëœ API í‚¤ ë³µì‚¬<br />
          âœ… ë¬´ë£Œ (í•˜ë£¨ 300íšŒ ë¬´ë£Œ í• ë‹¹ëŸ‰)
        </p>
      </div>

      <div id="errorMessage" class="error-message" style="display: none"></div>

      <div id="devicesSection" style="display: none">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
          "
        >
          <h2
            style="
              color: #1d1d1f;
              font-size: 1.1em;
              font-weight: 600;
              margin: 0;
            "
          >
            í˜„ì¬ ê¸°ê¸° ìœ„ì¹˜
          </h2>
          <span
            style="color: #86868b; font-size: 0.85em"
            id="currentDate"
          ></span>
        </div>
        <div id="devicesGrid" class="devices-grid"></div>
      </div>

      <div id="historySection" style="display: none" class="history-section">
        <h2>ğŸ“œ ìµœê·¼ ì´ë™ íˆìŠ¤í† ë¦¬ (ìµœê·¼ 20ê±´)</h2>
        <table class="history-table">
          <thead>
            <tr>
              <th>ê¸°ê¸°ID</th>
              <th>ë³´ìœ ì</th>
              <th>íƒ€ê²Ÿì—ê²Œë³´ë‚¸ë‚ </th>
              <th>íƒ€ê²Ÿì´ë°›ì€ë‚ </th>
              <th>ë‹¤ìŒíƒ€ê²Ÿ</th>
              <th>ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody id="historyTableBody"></tbody>
        </table>
      </div>

      <div class="last-updated" id="lastUpdated"></div>
    </div>

    <script>
      // ===== ì—¬ê¸°ì— ì„¤ì •ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” =====
      let config = {
        spreadsheetId: "1Q9M65gPsoG3-sv_-rtgdf92Hz0kCXRuPh5FcuE68QmM", // êµ¬ê¸€ ì‹œíŠ¸ ID ì…ë ¥
        apiKey: "AIzaSyAMrbcjL3xE_gCxcLnXlCsVJobMxzUzJW8", // Google Sheets API í‚¤ ì…ë ¥
        historySheetName: "ì´ë™_íˆìŠ¤í† ë¦¬",
      };

      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
      function loadConfig() {
        // ì½”ë“œì— ì„¤ì •ì´ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
        if (config.spreadsheetId && config.apiKey) {
          document.getElementById("configSection").style.display = "none";
          fetchData();
          return;
        }

        // ì—†ìœ¼ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        const saved = localStorage.getItem("sheetsConfig");
        if (saved) {
          config = JSON.parse(saved);
          document.getElementById("spreadsheetId").value =
            config.spreadsheetId || "";
          document.getElementById("apiKey").value = config.apiKey || "";
          document.getElementById("historySheetName").value =
            config.historySheetName || "ì´ë™_íˆìŠ¤í† ë¦¬";
          if (config.spreadsheetId && config.apiKey) {
            fetchData();
            document.getElementById("configSection").style.display = "none";
          }
        }
      }

      function saveConfig() {
        config.spreadsheetId = document
          .getElementById("spreadsheetId")
          .value.trim();
        config.apiKey = document.getElementById("apiKey").value.trim();
        config.historySheetName =
          document.getElementById("historySheetName").value.trim() ||
          "ì´ë™_íˆìŠ¤í† ë¦¬";

        if (!config.spreadsheetId || !config.apiKey) {
          showError("Spreadsheet IDì™€ API Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        localStorage.setItem("sheetsConfig", JSON.stringify(config));
        document.getElementById("configSection").style.display = "none";
        fetchData();
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }

      function parseDate(dateString) {
        if (!dateString) return null;
        // "2025. 11. 26" í˜•ì‹ì„ "2025-11-26"ìœ¼ë¡œ ë³€í™˜
        const cleaned = dateString.replace(/\.\s*/g, "-").trim();
        const parsed = new Date(cleaned);
        return isNaN(parsed.getTime()) ? null : parsed;
      }

      function calculateDays(date) {
        if (!date) return -1; // ë‚ ì§œê°€ ì—†ìœ¼ë©´ -1 ë°˜í™˜
        // Date ê°ì²´ê°€ ì•„ë‹ˆë©´ parseDateë¡œ ë³€í™˜
        const arrival = date instanceof Date ? date : parseDate(date);
        if (!arrival) return -1;
        const now = new Date();
        const diff = now - arrival;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      }

      function getDaysClass(days) {
        if (days >= 5) return "danger";
        if (days >= 3) return "warning";
        return "ok";
      }

      function getDaysBadgeClass(days) {
        if (days >= 5) return "days-danger";
        if (days >= 3) return "days-warning";
        return "days-ok";
      }

      function formatDeviceId(deviceId) {
        // A005 -> ì•ˆë“œë¡œì´ë“œ5, W005 -> ì›Œì¹˜5
        if (!deviceId) return deviceId;
        const type = deviceId[0];
        const number = parseInt(deviceId.substring(1)); // 001 -> 1, 005 -> 5
        if (type === "A") {
          return `ì•ˆë“œë¡œì´ë“œ${number}`;
        } else if (type === "W") {
          return `ì›Œì¹˜${number}`;
        }
        return deviceId;
      }

      async function fetchData() {
        try {
          // Google Sheets API v4 ì‚¬ìš© - íˆìŠ¤í† ë¦¬ë§Œ ì½ê¸°
          const baseUrl = `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values`;
          const historyUrl = `${baseUrl}/${encodeURIComponent(
            config.historySheetName
          )}!A2:G?key=${config.apiKey}`;

          console.log("íˆìŠ¤í† ë¦¬ API URL:", historyUrl);

          const historyResponse = await fetch(historyUrl);
          const historyResult = await historyResponse.json();

          if (historyResult.error) {
            let errorMsg = `âŒ API ì˜¤ë¥˜: ${historyResult.error.message}\n\n`;
            if (historyResult.error.code === 403) {
              errorMsg +=
                `ğŸ”§ í•´ê²° ë°©ë²•:\n` +
                `1. Google Cloud Console (console.cloud.google.com) ì ‘ì†\n` +
                `2. "API ë° ì„œë¹„ìŠ¤" â†’ "ì‚¬ìš©ì ì¸ì¦ ì •ë³´"\n` +
                `3. ìƒì„±í•œ API í‚¤ í´ë¦­\n` +
                `4. "API ì œí•œì‚¬í•­" â†’ "ì œí•œ ì•ˆí•¨" ì„ íƒ\n` +
                `5. "ì• í”Œë¦¬ì¼€ì´ì…˜ ì œí•œì‚¬í•­" â†’ "ì—†ìŒ" ì„ íƒ\n` +
                `6. ì €ì¥ í›„ ìƒˆë¡œê³ ì¹¨`;
            } else {
              errorMsg += `ì‹œíŠ¸ ì´ë¦„ì´ "${config.historySheetName}"ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`;
            }
            showError(errorMsg);
            return;
          }

          const historyData = historyResult.values || [];
          console.log("íˆìŠ¤í† ë¦¬ ë°ì´í„°:", historyData);

          if (!historyData || historyData.length === 0) {
            showError(
              `ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì‹œíŠ¸ ì´ë¦„ì´ "${config.historySheetName}"ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`
            );
            return;
          }

          renderDashboard(historyData);
          document.getElementById(
            "lastUpdated"
          ).textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString(
            "ko-KR"
          )}`;
        } catch (error) {
          showError(
            "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message
          );
          console.error("Error:", error);
        }
      }

      function renderDashboard(history) {
        // íˆìŠ¤í† ë¦¬ì—ì„œ ê° ê¸°ê¸°ì˜ ìµœì‹  ìƒíƒœ ì¶”ì¶œ
        const deviceStatus = {}; // deviceId -> ìµœì‹  ìƒíƒœ

        history.forEach((record) => {
          const [
            recordId,
            deviceId,
            owner,
            sentToTarget,
            receivedByTarget,
            nextOwner,
            note,
          ] = record;

          if (!deviceId) return;

          // ê¸°ê¸°ë³„ íˆìŠ¤í† ë¦¬ ì €ì¥
          if (!deviceStatus[deviceId]) {
            deviceStatus[deviceId] = [];
          }
          deviceStatus[deviceId].push({
            owner: owner || "-",
            sentToTarget: sentToTarget || "",
            receivedByTarget: receivedByTarget || "",
            nextOwner: nextOwner || "",
            note: note || "",
            recordId: recordId,
          });
        });

        // ê° ê¸°ê¸°ì˜ ìµœì‹  ìƒíƒœ ê³„ì‚°
        const currentDevices = {};
        Object.keys(deviceStatus).forEach((deviceId) => {
          const records = deviceStatus[deviceId];

          // í˜„ì¬ ë³´ìœ ì ì°¾ê¸°
          let currentOwner = "";
          let arrivalDate = new Date();
          let currentIndex = -1;

          // ì—­ìˆœìœ¼ë¡œ í™•ì¸ (ê°€ì¥ ìµœê·¼ë¶€í„°)
          let isShipping = false;
          let isCollecting = false;
          let currentNote = "";
          for (let i = records.length - 1; i >= 0; i--) {
            const record = records[i];

            // ë‹¤ìŒíƒ€ê²Ÿì´ ë¹„ì–´ìˆìœ¼ë©´ í˜„ì¬ ë³´ìœ ì ë˜ëŠ” ë°°ì†¡ì¤‘
            if (!record.nextOwner) {
              currentNote = record.note || "";
              // íƒ€ê²Ÿì—ê²Œë³´ë‚¸ë‚ ì€ ìˆëŠ”ë° íƒ€ê²Ÿì´ë°›ì€ë‚ ì´ ì—†ìœ¼ë©´ ë°°ì†¡ì¤‘
              if (record.sentToTarget && !record.receivedByTarget) {
                currentOwner = record.owner + " â†’ ë°°ì†¡ì¤‘";
                arrivalDate = parseDate(record.sentToTarget);
                isShipping = true;
              } else {
                // íƒ€ê²Ÿì´ë°›ì€ë‚ ì´ ìˆê±°ë‚˜ ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ìˆ˜ì§‘ì¤‘
                currentOwner = record.owner + " (ìˆ˜ì§‘ì¤‘)";
                arrivalDate = record.receivedByTarget
                  ? parseDate(record.receivedByTarget)
                  : null;
                isCollecting = true;
              }
              currentIndex = i;
              break;
            }
          }

          // í˜„ì¬ ë³´ìœ ìë¥¼ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ ë§ˆì§€ë§‰ ì‚¬ëŒ
          if (!currentOwner) {
            const lastRecord = records[records.length - 1];
            currentOwner = lastRecord.nextOwner || lastRecord.owner;
            arrivalDate = lastRecord.receivedByTarget
              ? parseDate(lastRecord.receivedByTarget)
              : null;
            currentIndex = records.length - 1;
          }

          // ì´ë™ ê²½ë¡œ êµ¬ì„± (ì´ì „ â†’ í˜„ì¬ â†’ ë‹¤ìŒ)
          const allOwners = records.map((r) => r.owner);
          if (records[records.length - 1].nextOwner) {
            allOwners.push(records[records.length - 1].nextOwner);
          }

          // ì¤‘ë³µ ì œê±°í•˜ì§€ ì•Šê³  ì „ì²´ ê²½ë¡œ ìœ ì§€
          const fullPath = allOwners;

          currentDevices[deviceId] = {
            deviceId,
            currentOwner,
            arrivalDate,
            isShipping,
            isCollecting,
            note: currentNote,
            path: fullPath, // ì „ì²´ ê²½ë¡œ ì €ì¥
            currentIndex:
              fullPath.length -
              1 -
              (records[records.length - 1].nextOwner ? 1 : 0), // í˜„ì¬ ë³´ìœ ì ì¸ë±ìŠ¤
            latestRecord: records[records.length - 1],
          };
        });

        // ê¸°ê¸° ê·¸ë£¹í•‘ (ê°™ì€ ì‚¬ëŒì´ ê°™ì€ ë²ˆí˜¸ì˜ A+Wë¥¼ ëª¨ë‘ ê°€ì§€ê³  ìˆì„ ë•Œë§Œ ë¬¶ê¸°)
        const deviceGroups = [];
        const processed = new Set();

        Object.values(currentDevices).forEach((device) => {
          if (processed.has(device.deviceId)) return;

          const deviceNum = device.deviceId.substring(1); // A001 -> 001
          const deviceType = device.deviceId[0]; // A or W
          const pairType = deviceType === "A" ? "W" : "A";
          const pairId = pairType + deviceNum;

          // ì§ ê¸°ê¸° ì°¾ê¸°
          const pairDevice = currentDevices[pairId];

          // ê°™ì€ ì‚¬ëŒì´ ë‘˜ ë‹¤ ê°€ì§€ê³  ìˆìœ¼ë©´ ë¬¶ê¸°
          if (pairDevice && pairDevice.currentOwner === device.currentOwner) {
            deviceGroups.push({
              key: deviceNum + "-" + device.currentOwner,
              devices: [device, pairDevice].sort((a, b) =>
                a.deviceId.localeCompare(b.deviceId)
              ),
            });
            processed.add(device.deviceId);
            processed.add(pairId);
          } else {
            // í•œìª½ë§Œ ìˆê±°ë‚˜ ë‹¤ë¥¸ ì‚¬ëŒì´ ê°€ì§€ê³  ìˆìœ¼ë©´ ë”°ë¡œ
            deviceGroups.push({
              key: device.deviceId + "-" + device.currentOwner,
              devices: [device],
            });
            processed.add(device.deviceId);
          }
        });

        // í†µê³„ ê³„ì‚°
        let androidCount = 0;
        let watchCount = 0;
        let warningCount = 0;
        let dangerCount = 0;
        let collectingCount = 0;

        Object.values(currentDevices).forEach((device) => {
          const days = calculateDays(device.arrivalDate);
          const type = device.deviceId[0];
          const ownerName = device.currentOwner
            .replace(" â†’ ë°°ì†¡ì¤‘", "")
            .replace(" (ìˆ˜ì§‘ì¤‘)", "");

          if (type === "A") androidCount++;
          if (type === "W") watchCount++;
          // "ë‚˜"ê°€ ë³´ìœ í•œ ê¸°ê¸°ëŠ” ìˆ˜ì§‘ì¤‘ì—ì„œ ì œì™¸
          if (device.isCollecting && ownerName !== "ë‚˜") collectingCount++;
          if (days >= 3 && days < 5) warningCount++;
          if (days >= 5) dangerCount++;
          // days < 0 ì¸ ê²½ìš° (ë‚ ì§œ ì—†ìŒ)ëŠ” í†µê³„ì—ì„œ ì œì™¸
        });

        // í†µê³„ ì—…ë°ì´íŠ¸
        const statsText = document.getElementById("statsText");
        statsText.innerHTML = `
          ì•ˆë“œë¡œì´ë“œ <span>${androidCount}</span> Â·
          ì›Œì¹˜ <span>${watchCount}</span> Â·
          ìˆ˜ì§‘ì¤‘ <span>${collectingCount}</span> Â·
          3ì¼+ <span>${warningCount}</span> Â·
          5ì¼+ <span>${dangerCount}</span>
        `;
        statsText.style.display = "block";

        // í˜„ì¬ ë‚ ì§œ í‘œì‹œ
        const currentDate = document.getElementById("currentDate");
        const today = new Date();
        currentDate.textContent = `ê¸°ì¤€: ${today.toLocaleDateString("ko-KR", {
          year: "numeric",
          month: "long",
          day: "numeric",
        })}`;

        // ê¸°ê¸° ê·¸ë£¹ë³„ ì¹´ë“œ ë Œë”ë§
        const devicesGrid = document.getElementById("devicesGrid");
        devicesGrid.innerHTML = "";

        // ê¸°ê¸° ë²ˆí˜¸ìˆœ ì •ë ¬
        deviceGroups.sort((a, b) => {
          const numA = parseInt(a.devices[0].deviceId.substring(1));
          const numB = parseInt(b.devices[0].deviceId.substring(1));
          return numA - numB;
        });

        deviceGroups.forEach((group) => {
          const devices = group.devices;

          // ë°°ì†¡ì¤‘ ë˜ëŠ” ìˆ˜ì§‘ì¤‘ ì—¬ë¶€ í™•ì¸
          const isShipping = devices.some((d) => d.isShipping);
          const isCollecting = devices.some((d) => d.isCollecting);

          // ê·¸ë£¹ ë‚´ ìµœëŒ€ ê²½ê³¼ì¼
          const maxDays = Math.max(
            ...devices.map((d) => calculateDays(d.arrivalDate))
          );
          const daysClass = maxDays < 0 ? "ok" : getDaysClass(maxDays);
          const daysBadgeClass =
            maxDays < 0 ? "days-ok" : getDaysBadgeClass(maxDays);

          let daysText;
          if (isShipping) {
            // ë°°ì†¡ì¤‘ì¸ ê²½ìš°
            if (maxDays < 0) {
              daysText = "ë°°ì†¡ ì˜ˆì •";
            } else if (maxDays === 0) {
              daysText = "ë°°ì†¡ì¤‘ (ì˜¤ëŠ˜ ë°œì†¡)";
            } else {
              daysText = `ë°°ì†¡ì¤‘ ${maxDays}ì¼`;
            }
          } else if (isCollecting) {
            // ìˆ˜ì§‘ì¤‘ì¸ ê²½ìš°
            if (maxDays < 0) {
              daysText = "ìˆ˜ì§‘ì¤‘";
            } else if (maxDays === 0) {
              daysText = "ìˆ˜ì§‘ì¤‘ (ì˜¤ëŠ˜ ì‹œì‘)";
            } else {
              daysText = `ìˆ˜ì§‘ì¤‘ ${maxDays}ì¼`;
            }
          } else if (maxDays < 0) {
            daysText = "ë‚ ì§œ ë¯¸ì •";
          } else {
            daysText =
              maxDays === 0
                ? "ì˜¤ëŠ˜ ë„ì°©"
                : maxDays === 1
                ? "1ì¼ ê²½ê³¼"
                : `${maxDays}ì¼ ê²½ê³¼`;
          }

          // í˜„ì¬ ë³´ìœ ì (ê·¸ë£¹ ë‚´ ëª¨ë“  ê¸°ê¸°ê°€ ê°™ì€ ì‚¬ëŒì—ê²Œ ìˆì–´ì•¼ í•¨)
          const owners = [...new Set(devices.map((d) => d.currentOwner))];
          const currentOwner =
            owners.length === 1 ? owners[0] : owners.join(", ");

          // "ë‚˜"ê°€ ë³´ìœ í•œ ê¸°ê¸°ì¸ì§€ í™•ì¸
          const ownerName = currentOwner
            .replace(" â†’ ë°°ì†¡ì¤‘", "")
            .replace(" (ìˆ˜ì§‘ì¤‘)", "");
          const isMyDevice = ownerName === "ë‚˜";

          // ì´ë™ ê²½ë¡œ HTML ìƒì„± (í˜„ì¬ ë³´ìœ ì ê°•ì¡°, ìµœëŒ€ 3ëª…)
          const fullPath = devices[0].path;
          const currentIndex = devices[0].currentIndex;

          // ìµœëŒ€ 3ëª…ë§Œ í‘œì‹œ (í˜„ì¬ ë³´ìœ ì í¬í•¨)
          let path = fullPath;
          if (fullPath.length > 3) {
            // í˜„ì¬ ë³´ìœ ìë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ìµœëŒ€ 3ëª… í‘œì‹œ
            if (currentIndex >= fullPath.length - 1) {
              // í˜„ì¬ ë³´ìœ ìê°€ ë§ˆì§€ë§‰ì´ë©´ ë’¤ì—ì„œ 3ëª…
              path = fullPath.slice(-3);
            } else {
              // í˜„ì¬ ë³´ìœ ìê°€ ì¤‘ê°„ì´ë©´ ì•ë’¤ í¬í•¨í•´ì„œ 3ëª…
              const start = Math.max(0, currentIndex - 1);
              path = fullPath.slice(start, start + 3);
            }
          }

          // pathê°€ ì˜ë ¸ìœ¼ë©´ currentIndex ì¬ê³„ì‚°
          const adjustedCurrentIndex = path.indexOf(fullPath[currentIndex]);

          let pathHTML =
            '<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">';

          path.forEach((person, index) => {
            const isCurrent = index === adjustedCurrentIndex;
            const isLast = index === path.length - 1;
            const isNext = isLast && !isCurrent; // ë‹¤ìŒ íƒ€ê²Ÿ (ë§ˆì§€ë§‰ì´ë©´ì„œ í˜„ì¬ê°€ ì•„ë‹Œ ê²½ìš°)

            // ê° ì‚¬ëŒ í‘œì‹œ
            let bgColor = "transparent";
            let textColor = "#86868b";
            let fontWeight = "400";

            if (isCurrent) {
              // í˜„ì¬ ë³´ìœ ì: ë§¥ íŒŒë€ìƒ‰
              bgColor = "#007AFF";
              textColor = "white";
              fontWeight = "600";
            } else if (isNext) {
              // ë‹¤ìŒ íƒ€ê²Ÿ: ì§™ì€ íšŒìƒ‰
              bgColor = "#3a3a3c";
              textColor = "#e5e5e7";
              fontWeight = "500";
            }

            pathHTML += `<span style="
                 display: inline-block;
                 padding: 4px 10px;
                 border-radius: 6px;
                 font-size: 0.9em;
                 font-weight: ${fontWeight};
                 color: ${textColor};
                 background: ${bgColor};
               ">${person}</span>`;

            // í™”ì‚´í‘œ (ë§ˆì§€ë§‰ì´ ì•„ë‹ˆë©´)
            if (!isLast) {
              pathHTML += `<span style="color: #d2d2d7; font-size: 0.85em;">â†’</span>`;
            }
          });
          pathHTML += "</div>";

          // ê¸°ê¸° ëª©ë¡ (í¬ë§· ì ìš©)
          const deviceIds = devices
            .map((d) => formatDeviceId(d.deviceId))
            .sort()
            .join(" + ");

          const groupCard = document.createElement("div");
          groupCard.className = `device-group ${daysClass}`;

          // ì§€ì—° ì •ë³´ (í˜„ì¬ ë³´ìœ ìì¸ ê²½ìš°) ë˜ëŠ” ë°°ì†¡ ì •ë³´
          let delayInfo = "";
          if (isShipping) {
            // ë°°ì†¡ì¤‘ì¸ ê²½ìš°
            if (maxDays > 0) {
              delayInfo = `<div style="font-size: 0.75em; color: #0066CC; margin-top: 6px;">
                 ë°°ì†¡ ${maxDays}ì¼ì°¨
               </div>`;
            }
          } else if (isCollecting) {
            // ìˆ˜ì§‘ì¤‘ì¸ ê²½ìš°
            if (maxDays > 0) {
              delayInfo = `<div style="font-size: 0.75em; color: #2E7D32; margin-top: 6px;">
                 ìˆ˜ì§‘ ${maxDays}ì¼ì°¨
               </div>`;
            }
          } else if (maxDays > 0) {
            // ì •ìƒ ë³´ìœ ì¤‘ì¸ ê²½ìš°
            delayInfo = `<div style="font-size: 0.75em; color: #8B4513; margin-top: 6px;">
               ${maxDays}ì¼ ê²½ê³¼
             </div>`;
          }

          // ë¹„ê³  ì •ë³´ (í˜„ì¬ ë³´ìœ ìì¸ ê²½ìš°)
          let noteInfo = "";
          const currentNotes = [
            ...new Set(devices.map((d) => d.note).filter((n) => n)),
          ];
          if (currentNotes.length > 0) {
            noteInfo = `<div style="font-size: 0.75em; color: #86868b; margin-top: 6px; padding-top: 6px; border-top: 1px solid #f5f5f7;">
               ğŸ’¬ ${currentNotes.join(", ")}
             </div>`;
          }

          groupCard.innerHTML = `
            <div class="device-group-header">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1em; font-weight: 600; color: ${
                  isMyDevice ? "#FF9500" : "#1d1d1f"
                };">${deviceIds}</span>
                <span class="days-badge ${daysBadgeClass}">${daysText}</span>
              </div>
            </div>
            <div style="padding: 8px 0;">
              <div style="font-size: 0.75em; color: #86868b; margin-bottom: 6px;">ì´ë™ ê²½ë¡œ</div>
              ${pathHTML}
              <div style="font-size: 0.75em; color: #86868b; margin-top: 8px;">
                ${isShipping ? "ë°œì†¡" : isCollecting ? "ì‹œì‘" : "ìˆ˜ë ¹"}: ${
            devices[0].arrivalDate
              ? devices[0].arrivalDate.toLocaleString("ko-KR", {
                  month: "short",
                  day: "numeric",
                })
              : "ì—†ìŒ"
          }
              </div>
              ${delayInfo}
              ${noteInfo}
            </div>
          `;

          devicesGrid.appendChild(groupCard);
        });

        // íˆìŠ¤í† ë¦¬ ë Œë”ë§ (ìµœê·¼ 20ê±´, ì—­ìˆœ)
        const historyTableBody = document.getElementById("historyTableBody");
        historyTableBody.innerHTML = "";

        const recentHistory = [...history].reverse().slice(0, 20);
        recentHistory.forEach((record) => {
          const [
            recordId,
            deviceId,
            owner,
            sentToTarget,
            receivedByTarget,
            nextOwner,
            note,
          ] = record;
          const row = document.createElement("tr");
          const sentDate = parseDate(sentToTarget);
          const receivedDate = parseDate(receivedByTarget);

          row.innerHTML = `
                    <td>${formatDeviceId(deviceId)}</td>
                    <td>${owner}</td>
                    <td>${
                      sentDate
                        ? sentDate.toLocaleString("ko-KR", {
                            month: "short",
                            day: "numeric",
                          })
                        : "-"
                    }</td>
                    <td>${
                      receivedDate
                        ? receivedDate.toLocaleString("ko-KR", {
                            month: "short",
                            day: "numeric",
                          })
                        : "-"
                    }</td>
                    <td>${nextOwner || "ë³´ìœ ì¤‘"}</td>
                    <td style="color: #86868b;">${note || "-"}</td>
                `;
          historyTableBody.appendChild(row);
        });

        // ì„¹ì…˜ í‘œì‹œ
        document.getElementById("devicesSection").style.display = "block";
        document.getElementById("historySection").style.display = "block";
      }

      // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
      setInterval(() => {
        if (config.spreadsheetId && config.apiKey) {
          fetchData();
        }
      }, 30000);

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
      loadConfig();
    </script>
  </body>
</html>
