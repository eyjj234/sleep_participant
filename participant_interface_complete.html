<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>수면 데이터 수집 - 참가자 페이지</title>
    <style>
      @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Apple SD Gothic Neo", sans-serif;
        background: #ffffff;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        border: 2px solid #000000;
        box-shadow: 0 4px 0 rgba(0, 0, 0, 1);
        margin-bottom: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 28px;
        color: #333;
        margin-bottom: 10px;
      }

      .header .subtitle {
        color: #666;
        font-size: 14px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .input-group input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #000000;
        box-shadow: 0 0 0 3px rgba(255, 235, 59, 0.3);
      }

      .btn {
        width: 100%;
        padding: 15px;
        background: #000000;
        color: white;
        border: 2px solid #000000;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn:hover:not(:disabled) {
        background: #333333;
        transform: translateY(-2px);
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
      }

      .btn:disabled {
        background: #cccccc;
        border-color: #cccccc;
        cursor: not-allowed;
        transform: none;
      }

      .progress-section {
        display: none;
      }

      .user-info {
        background: #000000;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        color: white;
        position: sticky;
        top: 20px;
        z-index: 100;
        box-shadow: 0 4px 0 rgba(0, 0, 0, 1);
      }

      .user-info h2 {
        font-size: 22px;
        margin-bottom: 15px;
      }

      .guide-banner {
        background: #ffeb3b;
        border: 2px solid #000000;
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
      }

      .guide-banner a {
        color: #000000;
        font-weight: bold;
        font-size: 15px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .guide-banner a:hover {
        text-decoration: underline;
      }

      .user-info .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .user-info .info-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 12px;
        border-radius: 10px;
      }

      .user-info .label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .user-info .value {
        font-size: 16px;
        font-weight: bold;
      }

      .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: bold;
        background: #ffeb3b;
        color: #000000;
        border: 2px solid #000000;
      }

      .alert {
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 25px;
        font-size: 15px;
        line-height: 1.6;
      }

      .alert-info {
        background: #f5f5f5;
        color: #000000;
        border: 2px solid #000000;
      }

      .alert-success {
        background: #ffeb3b;
        color: #000000;
        border: 2px solid #000000;
      }

      .alert-warning {
        background: #ffffff;
        color: #000000;
        border: 2px solid #000000;
        border-left: 4px solid #ffeb3b;
      }

      .timeline {
        position: relative;
        padding: 20px 0;
      }

      .timeline::before {
        content: "";
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: #000000;
      }

      .timeline-step {
        position: relative;
        padding-left: 60px;
        margin-bottom: 35px;
        opacity: 0.5;
        transition: opacity 0.3s;
      }

      .timeline-step.active,
      .timeline-step.completed {
        opacity: 1;
      }

      .timeline-step .step-circle {
        position: absolute;
        left: 8px;
        top: 0;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: #999;
        border: 3px solid white;
        z-index: 1;
      }

      .timeline-step.active .step-circle {
        background: #ffeb3b;
        color: #000000;
        box-shadow: 0 0 0 6px rgba(255, 235, 59, 0.3);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 6px rgba(255, 235, 59, 0.3);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(255, 235, 59, 0.15);
        }
      }

      .timeline-step.completed .step-circle {
        background: #000000;
        color: white;
      }

      .timeline-step.completed .step-circle::after {
        content: "✓";
      }

      .step-content {
        background: #f8f9fa;
        padding: 22px;
        border-radius: 12px;
        border-left: 4px solid #e9ecef;
      }

      .timeline-step.active .step-content {
        background: white;
        border-left-color: #ffeb3b;
        border: 2px solid #000000;
        box-shadow: 0 4px 0 rgba(0, 0, 0, 1);
      }

      .timeline-step.completed .step-content {
        border-left-color: #000000;
      }

      .step-title {
        font-size: 17px;
        font-weight: bold;
        color: #333;
        margin-bottom: 12px;
      }

      .step-description {
        font-size: 14px;
        color: #666;
        margin-bottom: 16px;
        line-height: 1.7;
      }

      .checklist {
        margin: 16px 0;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }

      .checklist-item {
        display: flex;
        align-items: center;
        padding: 10px;
        font-size: 14px;
        color: #333;
        border-radius: 6px;
        margin-bottom: 8px;
        transition: background 0.2s;
      }

      .checklist-item:hover {
        background: white;
      }

      .checklist-item input[type="checkbox"] {
        margin-right: 12px;
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .action-button {
        margin-top: 18px;
      }

      .guide-link {
        display: inline-flex;
        align-items: center;
        color: #000000;
        text-decoration: underline;
        font-size: 14px;
        margin-top: 12px;
        font-weight: 600;
        padding: 8px 0;
      }

      .guide-link:hover {
        background: #ffeb3b;
        padding: 8px 12px;
        border-radius: 4px;
        text-decoration: none;
      }

      .help-section {
        background: #f5f5f5;
        padding: 25px;
        border-radius: 12px;
        border: 2px solid #000000;
        margin-top: 25px;
        text-align: center;
      }

      .help-section h3 {
        font-size: 18px;
        color: #333;
        margin-bottom: 12px;
      }

      .help-section p {
        font-size: 14px;
        color: #666;
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .contact-button {
        display: inline-block;
        padding: 12px 30px;
        background: #ffeb3b;
        color: #000000;
        text-decoration: none;
        border-radius: 8px;
        border: 2px solid #000000;
        font-size: 15px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .contact-button:hover {
        background: #000000;
        color: #ffeb3b;
        transform: translateY(-2px);
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
      }

      .loading {
        text-align: center;
        padding: 50px;
        color: #666;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #000000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .logout-button {
        background: #6c757d;
        padding: 12px;
        font-size: 14px;
        margin-top: 15px;
      }

      .error-message {
        text-align: center;
        color: #dc3545;
        padding: 20px;
        font-size: 15px;
        background: #ffe6e6;
        border-radius: 10px;
        margin: 15px 0;
      }

      .collection-progress {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 12px;
        margin: 15px 0;
      }

      .collection-progress .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 12px;
      }

      .collection-progress .day-box {
        aspect-ratio: 1;
        background: white;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: #999;
        border: 2px solid #e9ecef;
      }

      .collection-progress .day-box.completed {
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      .collection-progress .day-box.current {
        background: #667eea;
        color: white;
        border-color: #667eea;
        animation: bounce 2s infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 로그인 카드 -->
      <div class="card" id="login-card">
        <div class="header">
          <h1>🌙 수면 데이터 수집</h1>
          <p class="subtitle">참가자 진행 현황 페이지</p>
        </div>

        <div class="input-group">
          <label for="participant-id">참가자 ID</label>
          <input
            type="text"
            id="participant-id"
            placeholder="예: 0001"
            maxlength="4"
            pattern="[0-9]{4}"
            inputmode="numeric"
          />
        </div>
        <div class="input-group">
          <label for="participant-name">이름</label>
          <input type="text" id="participant-name" placeholder="홍길동" />
        </div>
        <button class="btn" onclick="login()" id="login-btn">로그인</button>
        <p
          style="
            text-align: center;
            margin-top: 15px;
            font-size: 13px;
            color: #666;
          "
        >
          💬 참가자 ID는 참여요청 문자와 슬랙에서 확인할 수 있습니다.
        </p>
        <div id="login-error" class="error-message" style="display: none"></div>
      </div>

      <!-- 진행 현황 카드 -->
      <div class="card progress-section" id="progress-card">
        <div class="header">
          <h1>나의 진행 현황</h1>
        </div>

        <div class="user-info" id="user-info">
          <!-- 동적으로 생성 -->
        </div>

        <div class="guide-banner">
          <a
            href="https://docs.google.com/presentation/d/1UvG6Vl1lWJlcOITc3KmaJboFYnmo1FDiJ-nk9qrsrH8/edit?slide=id.p#slide=id.p"
            target="_blank"
          >
            📖 전체 수집 가이드를 읽고 진행해주세요 →
          </a>
        </div>

        <div id="current-alert" style="display: none">
          <!-- 동적으로 생성 -->
        </div>

        <div class="timeline" id="timeline">
          <!-- 동적으로 생성 -->
        </div>

        <div class="help-section">
          <h3>❓ 도움이 필요하신가요?</h3>
          <p>
            기기 연동이 안 되거나 문제가 발생하면<br />
            언제든 연락주세요. 빠르게 도와드리겠습니다!
          </p>
          <p
            style="
              font-size: 18px;
              font-weight: bold;
              color: #333;
              margin-top: 12px;
            "
          >
            💬 슬랙 채널에서 문의 (우선)<br />
            <span style="font-size: 15px; color: #666; font-weight: normal"
              >(급한 경우 📞 010-4343-4195)</span
            >
          </p>
        </div>

        <button class="btn logout-button" onclick="logout()">로그아웃</button>
      </div>
    </div>

    <script>
      // ===== 설정 =====
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzmoL1ZiRcMjXPQXtJj7C2lEpwug1NYz6y4TCSUGJLDp7Pd7uRw1OgLu7yW9huztAPJKQ/exec";
      let currentUser = null;

      // ===== 로그인 =====
      async function login() {
        const id = document.getElementById("participant-id").value.trim();
        const name = document.getElementById("participant-name").value.trim();

        if (!id || !name) {
          showError("login-error", "참가자 ID와 이름을 모두 입력해주세요.");
          return;
        }

        // 참가자 ID 유효성 검사 (숫자 4자리)
        if (!/^\d{4}$/.test(id)) {
          showError(
            "login-error",
            "참가자 ID는 숫자 4자리여야 합니다. (예: 0001)"
          );
          return;
        }

        const btn = document.getElementById("login-btn");
        btn.disabled = true;
        btn.textContent = "로그인 중...";

        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "getParticipant",
              id: id,
              name: name,
            }),
          });

          const result = await response.json();

          if (result.success) {
            currentUser = result.data;
            showProgress(result.data);
            document.getElementById("login-error").style.display = "none";
          } else {
            showError("login-error", result.message);
          }
        } catch (error) {
          showError(
            "login-error",
            "서버와 통신 중 오류가 발생했습니다. 다시 시도해주세요."
          );
          console.error(error);
        } finally {
          btn.disabled = false;
          btn.textContent = "로그인";
        }
      }

      // ===== 진행 현황 표시 =====
      function showProgress(data) {
        document.getElementById("login-card").style.display = "none";
        document.getElementById("progress-card").style.display = "block";

        // 사용자 정보 표시
        renderUserInfo(data);

        // 현재 상태 알림
        renderCurrentAlert(data);

        // 타임라인 렌더링
        renderTimeline(data);
      }

      // ===== 사용자 정보 렌더링 =====
      function renderUserInfo(data) {
        const statusColor = getStatusColor(data.status);

        document.getElementById("user-info").innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h2 style="margin: 0;">${data.name}님, 환영합니다! 👋</h2>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; opacity: 0.8;">참가자 ID</div>
                        <div style="font-size: 20px; font-weight: bold;">${data.id}</div>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="label">배정 기기</div>
                        <div class="value">${data.device}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">현재 상태</div>
                        <div class="value"><span class="status-badge" style="color: ${statusColor}">${data.status}</span></div>
                    </div>
                </div>
            `;
      }

      // ===== 현재 상태 알림 렌더링 =====
      function renderCurrentAlert(data) {
        const alertDiv = document.getElementById("current-alert");
        const alerts = {
          대기중: {
            type: "info",
            message: "곧 스마트워치가 발송될 예정입니다. 조금만 기다려주세요!",
          },
          발송완료: {
            type: "warning",
            message:
              "📦 스마트워치가 발송되었습니다. 택배를 받으시면 아래 버튼을 눌러주세요.",
          },
          수령확인필요: {
            type: "warning",
            message: "⚠️ 택배가 도착했을 예정입니다. 수령하셨나요?",
          },
          수령완료: {
            type: "info",
            message: "📱 이제 앱을 설치하고 기기를 연동해주세요.",
          },
          연동대기: {
            type: "warning",
            message:
              "⚠️ 아직 기기 연동이 확인되지 않았습니다. 가이드를 확인해주세요.",
          },
          연동완료: {
            type: "info",
            message: "✅ 기기 연동 완료! 이제 측정 예정일을 선택해주세요.",
          },
          수집중: {
            type: "warning",
            message: data.collectStartDate
              ? `😴 기상 예정일: ${data.collectStartDate} (전날 밤~해당일 아침 수면 측정)<br>스마트워치를 착용하고 주무세요.`
              : `⚠️ 연동 완료! 1-2일 내에 측정 부탁드리며, 추가 시간이 필요한 경우 슬랙으로 알려주세요.`,
          },
          수집완료: {
            type: "success",
            message:
              "🎉 측정이 완료되었습니다! 이제 앱에서 데이터를 확인해주세요.",
          },
        };

        const alert = alerts[data.status] || {
          type: "info",
          message: "상태를 확인 중입니다.",
        };

        alertDiv.className = "alert alert-" + alert.type;
        alertDiv.innerHTML = alert.message;
        alertDiv.style.display = "block";
      }

      // ===== 타임라인 렌더링 =====
      function renderTimeline(data) {
        const timeline = document.getElementById("timeline");
        const steps = getTimelineSteps(data);

        timeline.innerHTML = steps
          .map(
            (step, index) => `
                <div class="timeline-step ${step.state}" data-step="${
              index + 1
            }">
                    <div class="step-circle">${
                      step.state === "completed" || step.state === "active"
                        ? ""
                        : index + 1
                    }</div>
                    <div class="step-content">
                        <div class="step-title">${step.title}</div>
                        <div class="step-description">${step.description}</div>
                        ${step.content || ""}
                    </div>
                </div>
            `
          )
          .join("");
      }

      // ===== 타임라인 단계 생성 =====
      function getTimelineSteps(data) {
        const currentStep = getStepNumber(data.status);

        return [
          {
            state: currentStep >= 1 ? "completed" : "",
            title: "1단계: 참가 확정",
            description:
              "프로젝트 참가가 확정되었습니다. 곧 스마트워치가 발송될 예정입니다.",
          },
          {
            state:
              currentStep > 2 ? "completed" : currentStep === 2 ? "active" : "",
            title: "2단계: 택배 수령 대기",
            description: data.shipDate
              ? `발송일: ${data.shipDate}`
              : "스마트워치가 곧 발송됩니다.",
            content:
              currentStep === 2
                ? `
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-received">
                                <label for="check-received">택배를 수령했습니다</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-contents">
                                <label for="check-contents">스마트워치와 충전기가 모두 들어있습니다</label>
                            </div>
                        </div>
                        <div class="action-button">
                            <button class="btn" onclick="updateStatus('수령완료')">✓ 수령 완료 알리기</button>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 3 ? "completed" : currentStep === 3 ? "active" : "",
            title: "3단계: 앱 설치 및 기기 연동",
            description: "스마트워치 앱을 설치하고 기기를 연동해주세요.",
            content:
              currentStep === 3
                ? `
                        <a href="#" class="guide-link" onclick="openGuide('app'); return false;">📱 앱 설치 가이드 보기 →</a>
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-app-install">
                                <label for="check-app-install">앱을 설치했습니다</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-device-sync">
                                <label for="check-device-sync">스마트워치와 연동했습니다</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-data-visible">
                                <label for="check-data-visible">동기화 완료되어 "방금 동기화 완료"를 확인할 수 있습니다</label>
                            </div>
                        </div>
                        <div class="alert alert-info" style="margin-top: 12px; font-size: 13px;">
                            💡 동기화가 되었는지 불확실한 경우 슬랙으로 매니저에게 문의해주세요.
                        </div>
                        <div style="height: 0; overflow: hidden;">
                            <div class="checklist-item" style="display: none;">
                                <input type="checkbox" id="dummy-check" checked>
                                <label for="dummy-check">hidden</label>
                            </div>
                        </div>
                        <div class="action-button">
                            <button class="btn" onclick="updateStatus('연동완료')">✓ 연동 완료 알리기</button>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 4 ? "completed" : currentStep === 4 ? "active" : "",
            title: "4단계: 데이터 측정 (1일)",
            description: `스마트워치를 착용하고 하루 밤 수면을 측정해주세요.${
              data.collectStartDate
                ? "<br><strong>기상 예정일: " +
                  data.collectStartDate +
                  "</strong> (전날 밤부터 측정)"
                : "<br><span style='color: #ff6b6b;'>⚠️ 연동 후 1-2일 내 측정 부탁드립니다!</span>"
            }`,
            content:
              currentStep === 4
                ? `
                        <div style="background: #ffeb3b; padding: 20px; border-radius: 12px; border: 2px solid #000000; margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #000;">
                                📅 수면 측정 날짜 선택
                            </label>
                            <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 13px; color: #333; line-height: 1.6;">
                                💡 <strong>중요:</strong> 아침에 일어난 날짜를 선택하세요.<br>
                                <span style="color: #666;">
                                예) 26일 밤 11시에 잠들어 27일 아침 7시에 일어났다면<br>
                                → <strong>27일</strong>을 선택하세요 (26일 밤~27일 아침 수면)
                                </span>
                            </div>
                            <input type="date" id="measure-date" 
                                   value="${data.collectStartDate || ""}"
                                   style="width: 100%; padding: 12px; border: 2px solid #000000; border-radius: 8px; font-size: 16px;">
                            <button class="btn" onclick="updateMeasureDate()" 
                                    style="margin-top: 12px; background: #000000;">
                                📅 측정일 ${
                                  data.collectStartDate ? "변경" : "설정"
                                }하기
                            </button>
                        </div>

                        ${
                          data.collectStartDate
                            ? `
                            <div class="collection-progress">
                                <div style="text-align: center; font-weight: bold; color: #1976d2; margin-bottom: 8px;">
                                    측정 상태: ${
                                      data.status === "수집완료"
                                        ? "✅ 완료"
                                        : data.collectDays >= 1
                                        ? "✅ 측정일 도달"
                                        : "⏳ 대기중"
                                    }
                                </div>
                                <div style="text-align: center; padding: 20px; background: white; border-radius: 10px;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">
                                        ${
                                          data.status === "수집완료"
                                            ? "✅"
                                            : data.collectDays >= 1
                                            ? "🎯"
                                            : "😴"
                                        }
                                    </div>
                                    <div style="font-size: 16px; color: #666;">
                                        ${
                                          data.status === "수집완료"
                                            ? "측정 완료!"
                                            : data.collectDays >= 1
                                            ? "기상일이 되었습니다! 데이터를 확인해주세요"
                                            : "기상 예정일: " +
                                              data.collectStartDate +
                                              " (전날 밤부터 측정)"
                                        }
                                    </div>
                                </div>
                            </div>
                            <a href="#" class="guide-link" onclick="openGuide('check'); return false;">🔍 데이터 확인 방법 보기 →</a>
                        `
                            : ""
                        }

                        ${
                          data.collectDays >= 1
                            ? `
                            <div class="action-button">
                                <button class="btn" onclick="updateStatus('수집완료')">✓ 측정 완료 알리기</button>
                            </div>
                        `
                            : ""
                        }
                    `
                : "",
          },
          {
            state:
              currentStep > 5 ? "completed" : currentStep === 5 ? "active" : "",
            title: "5단계: 데이터 확인",
            description:
              "앱에서 수면 데이터가 정상적으로 기록되었는지 확인해주세요.",
            content:
              currentStep === 5
                ? `
                        <a href="#" class="guide-link" onclick="openGuide('check'); return false;">🔍 데이터 확인 방법 보기 →</a>
                        <div class="alert alert-info" style="margin-top: 16px; margin-bottom: 20px;">
                            📊 앱에서 지난 밤 수면 데이터(수면 시간, 단계 등)를 확인하신 후 아래 버튼을 눌러주세요.
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <p style="font-weight: bold; margin-bottom: 12px; color: #333;">
                                ✅ 데이터가 정상적으로 기록되었나요?
                            </p>
                        </div>

                        <div class="action-button" style="margin-bottom: 12px;">
                            <button class="btn" onclick="handleDataCheck(true)" style="background: #000000;">
                                ✓ 네, 데이터가 정상입니다
                            </button>
                        </div>
                        <div class="action-button">
                            <button class="btn" onclick="handleDataCheck(false)" style="background: #666666;">
                                ✗ 아니요, 문제가 있습니다
                            </button>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 6 ? "completed" : currentStep === 6 ? "active" : "",
            title: "6단계: 설문 작성",
            description: "수면 데이터 수집 후 설문조사에 참여해주세요.",
            content:
              currentStep === 6
                ? `
                        <div class="alert alert-success" style="margin-bottom: 20px;">
                            🎉 데이터 확인이 완료되었습니다! 설문 작성을 부탁드립니다.
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 2px solid #000000; margin-bottom: 20px;">
                            <p style="font-weight: bold; margin-bottom: 12px; color: #333;">
                                📝 설문 작성 (약 5-10분 소요)
                            </p>
                            <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                                아래 링크를 클릭하여 Google Form에서 설문을 작성해주세요.
                            </p>
                            <a href="https://docs.google.com/forms/d/1bYBF37q9ZE6Kkn3_NPYD-yDbLJvZK4jsWdYZC40w3wA/viewform" 
                               target="_blank"
                               style="display: inline-block; background: #ffeb3b; color: #000000; padding: 12px 24px; text-decoration: none; border-radius: 8px; border: 2px solid #000000; font-weight: bold; margin-bottom: 16px;">
                                📋 설문 작성하러 가기 →
                            </a>
                        </div>
                        
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-survey-done">
                                <label for="check-survey-done">설문 작성을 완료했습니다</label>
                            </div>
                        </div>
                        
                        <div class="action-button">
                            <button class="btn" onclick="updateStatus('설문완료')">✓ 설문 제출 완료</button>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 7 ? "completed" : currentStep === 7 ? "active" : "",
            title: "7단계: 데이터 제출",
            description: "수집된 데이터를 연구팀에 제출합니다.",
            content:
              currentStep === 7
                ? `
                        <div class="alert alert-success" style="margin-bottom: 20px;">
                            🎉 설문이 완료되었습니다! 이제 데이터를 제출해주세요.
                        </div>
                        
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-data-consent">
                                <label for="check-data-consent">수집된 데이터를 연구 목적으로 제공하는 것에 동의합니다</label>
                            </div>
                        </div>
                        
                        <div class="action-button">
                            <button class="btn" onclick="updateStatus('데이터제출완료')">✓ 데이터 제출하기</button>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 8 ? "completed" : currentStep === 8 ? "active" : "",
            title: "8단계: 매니저 데이터 확인",
            description:
              "매니저가 제출된 데이터를 검토 중입니다. 잠시만 기다려주세요.",
            content:
              currentStep === 8
                ? `
                        <div class="alert alert-info">
                            ⏳ 매니저가 데이터를 확인하는 중입니다...<br>
                            완료되면 자동으로 다음 단계로 진행됩니다.
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 9 ? "completed" : currentStep === 9 ? "active" : "",
            title: "9단계: 기기 반납 준비",
            description: `데이터 제출이 완료되었습니다!${
              data.pickupDate && data.pickupDate !== "조율 중"
                ? "<br><strong>회수 예정일: " + data.pickupDate + "</strong>"
                : "<br>곧 택배 회수 일정을 안내해드립니다."
            }`,
            content:
              currentStep === 9
                ? `
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-packed">
                                <label for="check-packed">스마트워치와 충전기를 박스에 담았습니다</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-ready">
                                <label for="check-ready">택배 기사님 방문 준비 완료</label>
                            </div>
                        </div>
                        <div class="action-button">
                            <button class="btn" onclick="updateStatus('회수대기')">✓ 반납 준비 완료 알리기</button>
                        </div>
                    `
                : "",
          },
          {
            state: currentStep >= 10 ? "completed" : "",
            title: "10단계: 완료! 🎉",
            description:
              "데이터 수집 프로젝트에 참여해주셔서 감사합니다!<br>귀하의 데이터는 수면 연구에 큰 도움이 될 것입니다.",
            content:
              currentStep >= 10
                ? `
                        <div class="alert alert-success">
                            ✅ 모든 단계가 완료되었습니다. 소정의 참가비는 2-3일 내로 지급됩니다.
                        </div>
                    `
                : "",
          },
        ];
      }

      // ===== 상태별 단계 번호 =====
      function getStepNumber(status) {
        const steps = {
          대기중: 1,
          슬랙참여: 1,
          발송완료: 2,
          수령확인필요: 2,
          수령완료: 3,
          연동대기: 3,
          연동완료: 3,
          수집중: 4,
          수집완료: 5,
          데이터확인완료: 6,
          설문완료: 7,
          데이터제출완료: 8,
          매니저확인완료: 9,
          회수대기: 9,
          회수완료: 10,
        };
        return steps[status] || 1;
      }

      // ===== 데이터 확인 처리 =====
      async function handleDataCheck(isOk) {
        if (!currentUser) return;

        if (isOk) {
          // 데이터가 정상인 경우 -> 데이터확인완료 상태로 변경
          await updateStatus("데이터확인완료");
        } else {
          // 문제가 있는 경우 -> 슬랙으로 문의 안내
          alert(
            "❗️ 슬랙에서 매니저에게 문의해주세요.\n\n문제 상황을 자세히 알려주시면 빠르게 도와드리겠습니다."
          );
        }
      }

      // ===== 상태 업데이트 =====
      async function updateStatus(newStatus) {
        if (!currentUser) return;

        // 체크리스트 확인
        if (!validateChecklist(newStatus)) {
          alert("✋ 체크리스트를 모두 완료해주세요.");
          return;
        }

        // 데이터확인완료는 confirm 없이 바로 진행
        const skipConfirm = newStatus === "데이터확인완료";
        if (
          !skipConfirm &&
          !confirm(`상태를 '${newStatus}'로 변경하시겠습니까?`)
        ) {
          return;
        }

        // 버튼 비활성화
        const buttons = document.querySelectorAll(".btn");
        buttons.forEach((btn) => (btn.disabled = true));

        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "updateStatus",
              id: currentUser.id,
              status: newStatus,
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert("✅ 상태가 업데이트되었습니다!");
            // 데이터 새로고침
            await refreshData();
          } else {
            alert("❌ 업데이트 실패: " + result.message);
          }
        } catch (error) {
          alert("❌ 서버와 통신 중 오류가 발생했습니다.");
          console.error(error);
        } finally {
          buttons.forEach((btn) => (btn.disabled = false));
        }
      }

      // ===== 데이터 새로고침 =====
      async function refreshData() {
        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "getParticipant",
              id: currentUser.id,
              name: currentUser.name,
            }),
          });

          const result = await response.json();
          if (result.success) {
            currentUser = result.data;
            showProgress(result.data);
          }
        } catch (error) {
          console.error(error);
        }
      }

      // ===== 측정일 업데이트 =====
      async function updateMeasureDate() {
        if (!currentUser) return;

        const dateInput = document.getElementById("measure-date");
        const selectedDate = dateInput.value;

        if (!selectedDate) {
          alert("📅 측정 예정일을 선택해주세요.");
          return;
        }

        if (!confirm(`측정 예정일을 ${selectedDate}로 설정하시겠습니까?`)) {
          return;
        }

        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "updateMeasureDate",
              id: currentUser.id,
              date: selectedDate,
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert("✅ 측정 예정일이 설정되었습니다!");
            await refreshData();
          } else {
            alert("❌ 업데이트 실패: " + result.message);
          }
        } catch (error) {
          alert("❌ 서버와 통신 중 오류가 발생했습니다.");
          console.error(error);
        }
      }

      // ===== 체크리스트 검증 =====
      function validateChecklist(status) {
        if (status === "수령완료") {
          const check1 = document.getElementById("check-received");
          const check2 = document.getElementById("check-contents");
          return check1 && check2 && check1.checked && check2.checked;
        }
        if (status === "연동완료") {
          const check1 = document.getElementById("check-app-install");
          const check2 = document.getElementById("check-device-sync");
          const check3 = document.getElementById("check-data-visible");
          return (
            check1 &&
            check2 &&
            check3 &&
            check1.checked &&
            check2.checked &&
            check3.checked
          );
        }
        if (status === "수집중") {
          // 수집중은 날짜 선택 후 자동으로 전환되므로 체크리스트 불필요
          return true;
        }
        if (status === "데이터확인완료") {
          return true; // 버튼 클릭으로 처리
        }
        if (status === "설문완료") {
          const check1 = document.getElementById("check-survey-done");
          return check1 && check1.checked;
        }
        if (status === "데이터제출완료") {
          const check1 = document.getElementById("check-data-consent");
          return check1 && check1.checked;
        }
        if (status === "회수대기") {
          const check1 = document.getElementById("check-packed");
          const check2 = document.getElementById("check-ready");
          return check1 && check2 && check1.checked && check2.checked;
        }
        return true;
      }

      // ===== 가이드 열기 =====
      function openGuide(type) {
        // 실제 가이드 문서 링크로 변경
        const guides = {
          app: "https://docs.google.com/presentation/d/1UvG6Vl1lWJlcOITc3KmaJboFYnmo1FDiJ-nk9qrsrH8/edit?slide=id.g37e30063af9_0_89#slide=id.g37e30063af9_0_89",
          check:
            "https://docs.google.com/presentation/d/1UvG6Vl1lWJlcOITc3KmaJboFYnmo1FDiJ-nk9qrsrH8/edit?slide=id.g37e30063af9_0_231#slide=id.g37e30063af9_0_231",
        };
        if (guides[type]) {
          window.open(guides[type], "_blank");
        }
      }

      // ===== 상태별 색상 =====
      function getStatusColor(status) {
        const colors = {
          대기중: "#6c757d",
          슬랙참여: "#2196f3",
          발송완료: "#ffa500",
          수령완료: "#2196f3",
          연동대기: "#ff6b6b",
          연동완료: "#2196f3",
          수집중: "#4caf50",
          수집완료: "#4caf50",
          회수대기: "#667eea",
          회수완료: "#333",
        };
        return colors[status] || "#6c757d";
      }

      // ===== 에러 표시 =====
      function showError(elementId, message) {
        const errorDiv = document.getElementById(elementId);
        errorDiv.textContent = "❌ " + message;
        errorDiv.style.display = "block";
      }

      // ===== 로그아웃 =====
      function logout() {
        currentUser = null;
        document.getElementById("login-card").style.display = "block";
        document.getElementById("progress-card").style.display = "none";
        document.getElementById("participant-id").value = "";
        document.getElementById("participant-name").value = "";
      }

      // ===== URL 파라미터 자동 로그인 =====
      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");
        const name = urlParams.get("name");

        if (id && name) {
          document.getElementById("participant-id").value = id;
          document.getElementById("participant-name").value = name;
          // 자동 로그인 원하면 login() 호출
        }
      };
    </script>
  </body>
</html>
