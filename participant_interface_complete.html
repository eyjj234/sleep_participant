<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÏàòÎ©¥ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë - Ï∞∏Í∞ÄÏûê ÌéòÏù¥ÏßÄ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Apple SD Gothic Neo", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      .card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 28px;
        color: #333;
        margin-bottom: 10px;
      }

      .header .subtitle {
        color: #666;
        font-size: 14px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .input-group input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .progress-section {
        display: none;
      }

      .user-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 25px;
        color: white;
      }

      .user-info h2 {
        font-size: 22px;
        margin-bottom: 15px;
      }

      .user-info .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .user-info .info-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 12px;
        border-radius: 10px;
      }

      .user-info .label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .user-info .value {
        font-size: 16px;
        font-weight: bold;
      }

      .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: bold;
        background: white;
      }

      .alert {
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 25px;
        font-size: 15px;
        line-height: 1.6;
      }

      .alert-info {
        background: #e3f2fd;
        color: #0d47a1;
        border-left: 5px solid #2196f3;
      }

      .alert-success {
        background: #e8f5e9;
        color: #1b5e20;
        border-left: 5px solid #4caf50;
      }

      .alert-warning {
        background: #fff3e0;
        color: #e65100;
        border-left: 5px solid #ff9800;
      }

      .timeline {
        position: relative;
        padding: 20px 0;
      }

      .timeline::before {
        content: "";
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #667eea 0%, #e9ecef 100%);
      }

      .timeline-step {
        position: relative;
        padding-left: 60px;
        margin-bottom: 35px;
        opacity: 0.5;
        transition: opacity 0.3s;
      }

      .timeline-step.active,
      .timeline-step.completed {
        opacity: 1;
      }

      .timeline-step .step-circle {
        position: absolute;
        left: 8px;
        top: 0;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: #999;
        border: 3px solid white;
        z-index: 1;
      }

      .timeline-step.active .step-circle {
        background: #667eea;
        color: white;
        box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.2);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.2);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(102, 126, 234, 0.1);
        }
      }

      .timeline-step.completed .step-circle {
        background: #4caf50;
        color: white;
      }

      .timeline-step.completed .step-circle::after {
        content: "‚úì";
      }

      .step-content {
        background: #f8f9fa;
        padding: 22px;
        border-radius: 12px;
        border-left: 4px solid #e9ecef;
      }

      .timeline-step.active .step-content {
        background: white;
        border-left-color: #667eea;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      }

      .timeline-step.completed .step-content {
        border-left-color: #4caf50;
      }

      .step-title {
        font-size: 17px;
        font-weight: bold;
        color: #333;
        margin-bottom: 12px;
      }

      .step-description {
        font-size: 14px;
        color: #666;
        margin-bottom: 16px;
        line-height: 1.7;
      }

      .checklist {
        margin: 16px 0;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }

      .checklist-item {
        display: flex;
        align-items: center;
        padding: 10px;
        font-size: 14px;
        color: #333;
        border-radius: 6px;
        margin-bottom: 8px;
        transition: background 0.2s;
      }

      .checklist-item:hover {
        background: white;
      }

      .checklist-item input[type="checkbox"] {
        margin-right: 12px;
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .action-button {
        margin-top: 18px;
      }

      .guide-link {
        display: inline-flex;
        align-items: center;
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        margin-top: 12px;
        font-weight: 600;
        padding: 8px 0;
      }

      .guide-link:hover {
        text-decoration: underline;
      }

      .help-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 25px;
        border-radius: 15px;
        margin-top: 25px;
        text-align: center;
      }

      .help-section h3 {
        font-size: 18px;
        color: #333;
        margin-bottom: 12px;
      }

      .help-section p {
        font-size: 14px;
        color: #666;
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .contact-button {
        display: inline-block;
        padding: 12px 30px;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .contact-button:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .loading {
        text-align: center;
        padding: 50px;
        color: #666;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .logout-button {
        background: #6c757d;
        padding: 12px;
        font-size: 14px;
        margin-top: 15px;
      }

      .error-message {
        text-align: center;
        color: #dc3545;
        padding: 20px;
        font-size: 15px;
        background: #ffe6e6;
        border-radius: 10px;
        margin: 15px 0;
      }

      .collection-progress {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 12px;
        margin: 15px 0;
      }

      .collection-progress .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 12px;
      }

      .collection-progress .day-box {
        aspect-ratio: 1;
        background: white;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: #999;
        border: 2px solid #e9ecef;
      }

      .collection-progress .day-box.completed {
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      .collection-progress .day-box.current {
        background: #667eea;
        color: white;
        border-color: #667eea;
        animation: bounce 2s infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Î°úÍ∑∏Ïù∏ Ïπ¥Îìú -->
      <div class="card" id="login-card">
        <div class="header">
          <h1>üåô ÏàòÎ©¥ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë</h1>
          <p class="subtitle">Ï∞∏Í∞ÄÏûê ÏßÑÌñâ ÌòÑÌô© ÌéòÏù¥ÏßÄ</p>
        </div>

        <div class="input-group">
          <label for="participant-id">Ï∞∏Í∞ÄÏûê ID</label>
          <input
            type="text"
            id="participant-id"
            placeholder="Ïòà: 0001"
            maxlength="4"
            pattern="[0-9]{4}"
            inputmode="numeric"
          />
        </div>
        <div class="input-group">
          <label for="participant-name">Ïù¥Î¶Ñ</label>
          <input type="text" id="participant-name" placeholder="ÌôçÍ∏∏Îèô" />
        </div>
        <button class="btn" onclick="login()" id="login-btn">Î°úÍ∑∏Ïù∏</button>
        <p
          style="
            text-align: center;
            margin-top: 15px;
            font-size: 13px;
            color: #666;
          "
        >
          üí¨ Ï∞∏Í∞ÄÏûê IDÎäî Î¨∏ÏûêÎ•º ÌÜµÌï¥ ÏïàÎÇ¥ÎìúÎ¶ΩÎãàÎã§.
        </p>
        <div id="login-error" class="error-message" style="display: none"></div>
      </div>

      <!-- ÏßÑÌñâ ÌòÑÌô© Ïπ¥Îìú -->
      <div class="card progress-section" id="progress-card">
        <div class="header">
          <h1>ÎÇòÏùò ÏßÑÌñâ ÌòÑÌô©</h1>
        </div>

        <div class="user-info" id="user-info">
          <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
        </div>

        <div id="current-alert" style="display: none">
          <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
        </div>

        <div class="timeline" id="timeline">
          <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
        </div>

        <div class="help-section">
          <h3>‚ùì ÎèÑÏõÄÏù¥ ÌïÑÏöîÌïòÏã†Í∞ÄÏöî?</h3>
          <p>
            Í∏∞Í∏∞ Ïó∞ÎèôÏù¥ Ïïà ÎêòÍ±∞ÎÇò Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÎ©¥<br />Ïñ∏Ï†úÎì† Ïó∞ÎùΩÏ£ºÏÑ∏Ïöî. Îπ†Î•¥Í≤å
            ÎèÑÏôÄÎìúÎ¶¨Í≤†ÏäµÎãàÎã§!
          </p>
          <p
            style="
              font-size: 16px;
              font-weight: 600;
              color: #667eea;
              margin-top: 15px;
              line-height: 1.8;
            "
          >
            üìû Ïä¨Îûô Ï±ÑÎÑêÏóêÏÑú Î¨∏Ïùò<br />
            <span style="font-size: 14px; color: #666"
              >(Í∏âÌïú Í≤ΩÏö∞ 010-4343-4195)</span
            >
          </p>
        </div>

        <button class="btn logout-button" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
    </div>

    <script>
      // ===== ÏÑ§Ï†ï =====
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxkaLKygRzsMeWkqcZPmUqndmHtkAMcgl_yKOmrjsv0iDgxSiRct_LMehBg7w2c_QfJIQ/exec";
      let currentUser = null;

      // ===== Î°úÍ∑∏Ïù∏ =====
      async function login() {
        const id = document.getElementById("participant-id").value.trim();
        const name = document.getElementById("participant-name").value.trim();

        if (!id || !name) {
          showError("login-error", "Ï∞∏Í∞ÄÏûê IDÏôÄ Ïù¥Î¶ÑÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
          return;
        }

        // Ï∞∏Í∞ÄÏûê ID Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ (Ïà´Ïûê 4ÏûêÎ¶¨)
        if (!/^\d{4}$/.test(id)) {
          showError(
            "login-error",
            "Ï∞∏Í∞ÄÏûê IDÎäî Ïà´Ïûê 4ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§. (Ïòà: 0001)"
          );
          return;
        }

        const btn = document.getElementById("login-btn");
        btn.disabled = true;
        btn.textContent = "Î°úÍ∑∏Ïù∏ Ï§ë...";

        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "getParticipant",
              id: id,
              name: name,
            }),
          });

          const result = await response.json();

          if (result.success) {
            currentUser = result.data;
            showProgress(result.data);
            document.getElementById("login-error").style.display = "none";
          } else {
            showError("login-error", result.message);
          }
        } catch (error) {
          showError(
            "login-error",
            "ÏÑúÎ≤ÑÏôÄ ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî."
          );
          console.error(error);
        } finally {
          btn.disabled = false;
          btn.textContent = "Î°úÍ∑∏Ïù∏";
        }
      }

      // ===== ÏßÑÌñâ ÌòÑÌô© ÌëúÏãú =====
      function showProgress(data) {
        document.getElementById("login-card").style.display = "none";
        document.getElementById("progress-card").style.display = "block";

        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú
        renderUserInfo(data);

        // ÌòÑÏû¨ ÏÉÅÌÉú ÏïåÎ¶º
        renderCurrentAlert(data);

        // ÌÉÄÏûÑÎùºÏù∏ Î†åÎçîÎßÅ
        renderTimeline(data);
      }

      // ===== ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î†åÎçîÎßÅ =====
      function renderUserInfo(data) {
        const statusColor = getStatusColor(data.status);

        document.getElementById("user-info").innerHTML = `
                <h2>${data.name}Îãò, ÌôòÏòÅÌï©ÎãàÎã§! üëã</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="label">Ï∞∏Í∞ÄÏûê ID</div>
                        <div class="value">${data.id}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Î∞∞Ï†ï Í∏∞Í∏∞</div>
                        <div class="value">${data.device}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ÌòÑÏû¨ ÏÉÅÌÉú</div>
                        <div class="value"><span class="status-badge" style="color: ${statusColor}">${
          data.status
        }</span></div>
                    </div>
                    <div class="info-item">
                        <div class="label">${
                          data.status === "ÏàòÏßëÏ§ë" ? "Ï∏°Ï†ï ÏÉÅÌÉú" : "ÏßÑÌñâ Í≤ΩÍ≥º"
                        }</div>
                        <div class="value">${
                          data.status === "ÏàòÏßëÏ§ë"
                            ? data.collectDays >= 1
                              ? "ÏôÑÎ£å"
                              : "ÎåÄÍ∏∞Ï§ë"
                            : data.daysElapsed + "Ïùº"
                        }</div>
                    </div>
                </div>
            `;
      }

      // ===== ÌòÑÏû¨ ÏÉÅÌÉú ÏïåÎ¶º Î†åÎçîÎßÅ =====
      function renderCurrentAlert(data) {
        const alertDiv = document.getElementById("current-alert");
        const alerts = {
          ÎåÄÍ∏∞Ï§ë: {
            type: "info",
            message:
              "Ïä¨Îûô ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Ïóê Ï∞∏Ïó¨ÌïòÏÖ®ÎÇòÏöî? Î¨∏ÏûêÎ°ú Î∞õÏùÄ Ï¥àÎåÄ ÎßÅÌÅ¨Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî!",
          },
          Ïä¨ÎûôÏ∞∏Ïó¨: {
            type: "info",
            message: "Ïä¨Îûô Ï∞∏Ïó¨ ÏôÑÎ£å! Í≥ß Ïä§ÎßàÌä∏ÏõåÏπòÍ∞Ä Î∞úÏÜ°Îê† ÏòàÏ†ïÏûÖÎãàÎã§.",
          },
          Î∞úÏÜ°ÏôÑÎ£å: {
            type: "warning",
            message:
              "üì¶ Ïä§ÎßàÌä∏ÏõåÏπòÍ∞Ä Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§. ÌÉùÎ∞∞Î•º Î∞õÏúºÏãúÎ©¥ ÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.",
          },
          ÏàòÎ†πÌôïÏù∏ÌïÑÏöî: {
            type: "warning",
            message: "‚ö†Ô∏è ÌÉùÎ∞∞Í∞Ä ÎèÑÏ∞©ÌñàÏùÑ ÏòàÏ†ïÏûÖÎãàÎã§. ÏàòÎ†πÌïòÏÖ®ÎÇòÏöî?",
          },
          ÏàòÎ†πÏôÑÎ£å: {
            type: "info",
            message: "üì± Ïù¥Ï†ú Ïï±ÏùÑ ÏÑ§ÏπòÌïòÍ≥† Í∏∞Í∏∞Î•º Ïó∞ÎèôÌï¥Ï£ºÏÑ∏Ïöî.",
          },
          Ïó∞ÎèôÎåÄÍ∏∞: {
            type: "warning",
            message:
              "‚ö†Ô∏è ÏïÑÏßÅ Í∏∞Í∏∞ Ïó∞ÎèôÏù¥ ÌôïÏù∏ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Í∞ÄÏù¥ÎìúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.",
          },
          ÏàòÏßëÏ§ë: {
            type: "warning",
            message: data.collectStartDate
              ? `üò¥ Ï∏°Ï†ï ÏòàÏ†ïÏùº: ${data.collectStartDate}. Ìï¥Îãπ ÎÇ†ÏßúÏóê Ïä§ÎßàÌä∏ÏõåÏπòÎ•º Ï∞©Ïö©ÌïòÍ≥† Ï£ºÎ¨¥ÏÑ∏Ïöî.`
              : `‚ö†Ô∏è Ïó∞Îèô ÏôÑÎ£å! 1-2Ïùº ÎÇ¥Ïóê Ï∏°Ï†ï Î∂ÄÌÉÅÎìúÎ¶¨Î©∞, Ï∂îÍ∞Ä ÏãúÍ∞ÑÏù¥ ÌïÑÏöîÌïú Í≤ΩÏö∞ Îß§ÎãàÏ†ÄÏóêÍ≤å ÏïåÎ†§Ï£ºÏÑ∏Ïöî. (üìû 010-4343-4195)`,
          },
          ÏàòÏßëÏôÑÎ£å: {
            type: "success",
            message:
              "üéâ Ï∏°Ï†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Ïù¥Ï†ú Ïï±ÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.",
          },
          Îç∞Ïù¥ÌÑ∞ÌôïÏù∏Ï§ë: {
            type: "info",
            message:
              "üìä Ïï±ÏóêÏÑú ÏàòÎ©¥ Îç∞Ïù¥ÌÑ∞Í∞Ä 4Îã®Í≥ÑÎ°ú Í∏∞Î°ùÎêòÏóàÎäîÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.",
          },
          Îç∞Ïù¥ÌÑ∞Ï†úÏ∂úÎåÄÍ∏∞: {
            type: "warning",
            message: "üì§ Í∞ÄÏù¥ÎìúÎ•º Îî∞Îùº Îç∞Ïù¥ÌÑ∞Î•º Ïù¥Î©îÏùºÎ°ú Ï†úÏ∂úÌï¥Ï£ºÏÑ∏Ïöî.",
          },
          Îß§ÎãàÏ†ÄÌôïÏù∏Ï§ë: {
            type: "info",
            message: "‚è≥ Îß§ÎãàÏ†ÄÍ∞Ä Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏ Ï§ëÏûÖÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.",
          },
        };

        const alert = alerts[data.status] || {
          type: "info",
          message: "ÏÉÅÌÉúÎ•º ÌôïÏù∏ Ï§ëÏûÖÎãàÎã§.",
        };

        alertDiv.className = "alert alert-" + alert.type;
        alertDiv.innerHTML = alert.message;
        alertDiv.style.display = "block";
      }

      // ===== ÌÉÄÏûÑÎùºÏù∏ Î†åÎçîÎßÅ =====
      function renderTimeline(data) {
        const timeline = document.getElementById("timeline");
        const steps = getTimelineSteps(data);

        timeline.innerHTML = steps
          .map(
            (step, index) => `
                <div class="timeline-step ${step.state}" data-step="${
              index + 1
            }">
                    <div class="step-circle">${
                      step.state === "completed" || step.state === "active"
                        ? ""
                        : index + 1
                    }</div>
                    <div class="step-content">
                        <div class="step-title">${step.title}</div>
                        <div class="step-description">${step.description}</div>
                        ${step.content || ""}
                    </div>
                </div>
            `
          )
          .join("");
      }

      // ===== ÌÉÄÏûÑÎùºÏù∏ Îã®Í≥Ñ ÏÉùÏÑ± =====
      function getTimelineSteps(data) {
        const currentStep = getStepNumber(data.status);

        return [
          {
            state: currentStep >= 1 ? "completed" : "",
            title: "1Îã®Í≥Ñ: Ï∞∏Í∞Ä ÌôïÏ†ï & Ïä¨Îûô Ï∞∏Ïó¨",
            description:
              "ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Í∞ÄÍ∞Ä ÌôïÏ†ïÎêòÏóàÏäµÎãàÎã§. Ïä¨Îûô ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Ïóê Ï∞∏Ïó¨Ìï¥Ï£ºÏÑ∏Ïöî.",
            content:
              currentStep === 1
                ? `
                        <div class="alert alert-info">
                            üì± Ïä¨Îûô(Slack) ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Ïóê Ï¥àÎåÄÎêòÏÖ®ÏäµÎãàÎã§.<br>
                            Î¨∏ÏûêÎ°ú Î∞õÏúºÏã† Ï¥àÎåÄ ÎßÅÌÅ¨Î•º ÌÜµÌï¥ Ï∞∏Ïó¨Ìï¥Ï£ºÏÑ∏Ïöî.
                        </div>
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-slack-join">
                                <label for="check-slack-join">Ïä¨Îûô ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Ïóê Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-slack-check">
                                <label for="check-slack-check">Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ ÌôïÏù∏ÌñàÏäµÎãàÎã§</label>
                            </div>
                        </div>
                        <p style="font-size: 13px; color: #666; margin-top: 10px;">
                            üí° Ïä¨ÎûôÏóêÏÑú Ïã§ÏãúÍ∞Ñ Í≥µÏßÄÏôÄ Î¨∏ÏùòÏùëÎãµÏùÑ Î∞õÏúºÏã§ Ïàò ÏûàÏäµÎãàÎã§.
                        </p>
                    `
                : "",
          },
          {
            state:
              currentStep > 2 ? "completed" : currentStep === 2 ? "active" : "",
            title: "2Îã®Í≥Ñ: ÌÉùÎ∞∞ ÏàòÎ†π ÎåÄÍ∏∞",
            description: data.shipDate
              ? `Î∞úÏÜ°Ïùº: ${data.shipDate}`
              : "Ïä§ÎßàÌä∏ÏõåÏπòÍ∞Ä Í≥ß Î∞úÏÜ°Îê©ÎãàÎã§.",
            content:
              currentStep === 2
                ? `
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-received">
                                <label for="check-received">ÌÉùÎ∞∞Î•º ÏàòÎ†πÌñàÏäµÎãàÎã§</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-contents">
                                <label for="check-contents">Ïä§ÎßàÌä∏ÏõåÏπòÏôÄ Ï∂©Ï†ÑÍ∏∞Í∞Ä Î™®Îëê Îì§Ïñ¥ÏûàÏäµÎãàÎã§</label>
                            </div>
                        </div>
                        <div class="action-button">
                            <button class="btn" onclick="updateStatus('ÏàòÎ†πÏôÑÎ£å')">‚úì ÏàòÎ†π ÏôÑÎ£å ÏïåÎ¶¨Í∏∞</button>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 3 ? "completed" : currentStep === 3 ? "active" : "",
            title: "3Îã®Í≥Ñ: Ïï± ÏÑ§Ïπò Î∞è Í∏∞Í∏∞ Ïó∞Îèô",
            description: "Ïä§ÎßàÌä∏ÏõåÏπò Ïï±ÏùÑ ÏÑ§ÏπòÌïòÍ≥† Í∏∞Í∏∞Î•º Ïó∞ÎèôÌï¥Ï£ºÏÑ∏Ïöî.",
            content:
              currentStep === 3
                ? `
                        <a href="#" class="guide-link" onclick="openGuide('app'); return false;">üì± Ïï± ÏÑ§Ïπò Í∞ÄÏù¥Îìú Î≥¥Í∏∞ ‚Üí</a>
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-app-install">
                                <label for="check-app-install">Ïï±ÏùÑ ÏÑ§ÏπòÌñàÏäµÎãàÎã§</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-device-sync">
                                <label for="check-device-sync">Ïä§ÎßàÌä∏ÏõåÏπòÏôÄ Ïó∞ÎèôÌñàÏäµÎãàÎã§</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-data-visible">
                                <label for="check-data-visible">Ïï±ÏóêÏÑú ÏàòÎ©¥ Îç∞Ïù¥ÌÑ∞Í∞Ä Î≥¥ÏûÖÎãàÎã§</label>
                            </div>
                        </div>
                        <div class="action-button">
                            <button class="btn" onclick="updateStatus('ÏàòÏßëÏ§ë')">‚úì Ïó∞Îèô ÏôÑÎ£å ÏïåÎ¶¨Í∏∞</button>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 4 ? "completed" : currentStep === 4 ? "active" : "",
            title: "4Îã®Í≥Ñ: Îç∞Ïù¥ÌÑ∞ Ï∏°Ï†ï (1Ïùº)",
            description: `Ïä§ÎßàÌä∏ÏõåÏπòÎ•º Ï∞©Ïö©ÌïòÍ≥† ÌïòÎ£® Î∞§ ÏàòÎ©¥ÏùÑ Ï∏°Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.${
              data.collectStartDate
                ? "<br><strong>Ï∏°Ï†ï ÏòàÏ†ïÏùº: " +
                  data.collectStartDate +
                  "</strong>"
                : "<br><span style='color: #ff6b6b;'>‚ö†Ô∏è Ïó∞Îèô ÌõÑ 1-2Ïùº ÎÇ¥ Ï∏°Ï†ï Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§!</span>"
            }`,
            content:
              currentStep === 4
                ? `
                        <div class="alert alert-warning" style="margin-bottom: 20px;">
                            ‚è∞ Ïó∞Îèô ÏôÑÎ£å ÌõÑ 1-2Ïùº ÎÇ¥Ïóê Ï∏°Ï†ï Î∂ÄÌÉÅÎìúÎ¶¨Î©∞,<br>
                            Ï∂îÍ∞Ä ÏãúÍ∞ÑÏù¥ ÌïÑÏöîÌïú Í≤ΩÏö∞ Îß§ÎãàÏ†ÄÏóêÍ≤å Ïó∞ÎùΩÏ£ºÏÑ∏Ïöî.<br>
                            üìû 010-4343-4195
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">
                                üìÖ Ï∏°Ï†ï ÏòàÏ†ïÏùº ÏÑ†ÌÉù
                            </label>
                            <input type="date" id="measure-date" 
                                   value="${data.collectStartDate || ""}"
                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                            <button class="btn" onclick="updateMeasureDate()" 
                                    style="margin-top: 12px; background: #2196f3;">
                                üìÖ Ï∏°Ï†ïÏùº ${
                                  data.collectStartDate ? "Î≥ÄÍ≤Ω" : "ÏÑ§Ï†ï"
                                }ÌïòÍ∏∞
                            </button>
                        </div>

                        ${
                          data.collectStartDate
                            ? `
                            <div class="collection-progress">
                                <div style="text-align: center; font-weight: bold; color: #1976d2; margin-bottom: 8px;">
                                    Ï∏°Ï†ï ÏÉÅÌÉú: ${
                                      data.collectDays >= 1
                                        ? "‚úÖ ÏôÑÎ£å"
                                        : "‚è≥ ÎåÄÍ∏∞Ï§ë"
                                    }
                                </div>
                                <div style="text-align: center; padding: 20px; background: white; border-radius: 10px;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">
                                        ${data.collectDays >= 1 ? "‚úÖ" : "üò¥"}
                                    </div>
                                    <div style="font-size: 16px; color: #666;">
                                        ${
                                          data.collectDays >= 1
                                            ? "Ï∏°Ï†ï ÏôÑÎ£å!"
                                            : "Ï∏°Ï†ï ÏòàÏ†ïÏùº: " +
                                              data.collectStartDate
                                        }
                                    </div>
                                </div>
                            </div>
                            <a href="#" class="guide-link" onclick="openGuide('check'); return false;">üîç Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ Î∞©Î≤ï Î≥¥Í∏∞ ‚Üí</a>
                        `
                            : ""
                        }

                        ${
                          data.collectDays >= 1
                            ? `
                            <div class="action-button">
                                <button class="btn" onclick="updateStatus('ÏàòÏßëÏôÑÎ£å')">‚úì Ï∏°Ï†ï ÏôÑÎ£å ÏïåÎ¶¨Í∏∞</button>
                            </div>
                        `
                            : ""
                        }
                    `
                : "",
          },
          {
            state:
              currentStep > 5 ? "completed" : currentStep === 5 ? "active" : "",
            title: "5Îã®Í≥Ñ: Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏",
            description:
              "Ï∏°Ï†ï ÎãπÏùºÏóê Ïï±Ïóê ÏàòÎ©¥ Îç∞Ïù¥ÌÑ∞Í∞Ä 4Îã®Í≥ÑÎ°ú Í∏∞Î°ùÎêòÏóàÎäîÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.",
            content:
              currentStep === 5
                ? `
                        <div class="alert alert-info" style="margin-bottom: 20px;">
                            üì± Ïï±ÏùÑ Ïó¥Ïñ¥ Ï∏°Ï†ï ÎãπÏùºÏùò ÏàòÎ©¥ Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.<br>
                            ÏàòÎ©¥ Îã®Í≥ÑÍ∞Ä 4Îã®Í≥Ñ(ÍπäÏùÄÏàòÎ©¥, ÏñïÏùÄÏàòÎ©¥, REMÏàòÎ©¥, Íπ®Ïñ¥ÏûàÏùå)Î°ú ÌëúÏãúÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.
                        </div>
                        
                        <a href="https://docs.google.com/presentation/d/1UvG6Vl1lWJlcOITc3KmaJboFYnmo1FDiJ-nk9qrsrH8/edit?slide=id.g37e30063af9_0_231#slide=id.g37e30063af9_0_231" 
                           class="guide-link" 
                           target="_blank"
                           style="display: block; margin-bottom: 20px;">
                            üîç Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ Î∞©Î≤ï Î≥¥Í∏∞ ‚Üí
                        </a>

                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 15px; color: #333;">
                                üìä Ïï±Ïóê Îç∞Ïù¥ÌÑ∞Í∞Ä 4Îã®Í≥ÑÎ°ú Í∏∞Î°ùÎêòÏóàÏäµÎãàÍπå?
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="handleDataCheck('yes')" 
                                        style="flex: 1; background: #4caf50;">
                                    ‚úÖ ÎÑ§, 4Îã®Í≥ÑÎ°ú Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§
                                </button>
                                <button class="btn" onclick="handleDataCheck('no')" 
                                        style="flex: 1; background: #ff6b6b;">
                                    ‚ùå ÏïÑÎãàÏò§, Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§
                                </button>
                            </div>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 6 ? "completed" : currentStep === 6 ? "active" : "",
            title: "6Îã®Í≥Ñ: Îç∞Ïù¥ÌÑ∞ Ï†úÏ∂ú",
            description: "Í∞ÄÏù¥ÎìúÎ•º Îî∞Îùº ÏàòÎ©¥ Îç∞Ïù¥ÌÑ∞Î•º Ïù¥Î©îÏùºÎ°ú Ï†úÏ∂úÌï¥Ï£ºÏÑ∏Ïöî.",
            content:
              currentStep === 6
                ? `
                        <div class="alert alert-warning" style="margin-bottom: 20px;">
                            üì§ ÏïÑÎûò Í∞ÄÏù¥ÎìúÎ•º Îî∞Îùº Îç∞Ïù¥ÌÑ∞Î•º Ïù¥Î©îÏùºÎ°ú Ï†úÏ∂úÌï¥Ï£ºÏÑ∏Ïöî.
                        </div>
                        
                        <a href="https://docs.google.com/presentation/d/1UvG6Vl1lWJlcOITc3KmaJboFYnmo1FDiJ-nk9qrsrH8/edit?slide=id.g37e30063af9_0_231#slide=id.g37e30063af9_0_231" 
                           class="guide-link" 
                           target="_blank"
                           style="display: block; font-size: 16px; padding: 15px; background: white; border-radius: 10px; margin-bottom: 20px;">
                            üìÑ Îç∞Ïù¥ÌÑ∞ Ï†úÏ∂ú Í∞ÄÏù¥Îìú Î≥¥Í∏∞ ‚Üí
                        </a>

                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-guide-read">
                                <label for="check-guide-read">Í∞ÄÏù¥ÎìúÎ•º ÏùΩÏóàÏäµÎãàÎã§</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-data-submitted">
                                <label for="check-data-submitted">Îç∞Ïù¥ÌÑ∞Î•º Ïù¥Î©îÏùºÎ°ú Ï†úÏ∂úÌñàÏäµÎãàÎã§</label>
                            </div>
                        </div>
                        
                        <div class="action-button">
                            <button class="btn" onclick="updateStatus('Îç∞Ïù¥ÌÑ∞Ï†úÏ∂úÏôÑÎ£å')">‚úì Ï†úÏ∂ú ÏôÑÎ£å ÏïåÎ¶¨Í∏∞</button>
                        </div>
                    `
                : "",
          },
          {
            state:
              currentStep > 7 ? "completed" : currentStep === 7 ? "active" : "",
            title: "7Îã®Í≥Ñ: Îß§ÎãàÏ†Ä Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏",
            description: "Îß§ÎãàÏ†ÄÍ∞Ä Ï†úÏ∂úÌïòÏã† Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏ÌïòÍ≥† ÏûàÏäµÎãàÎã§.",
            content:
              currentStep === 7
                ? `
                        <div class="alert alert-info" style="margin-bottom: 20px;">
                            ‚è≥ Îß§ÎãàÏ†ÄÍ∞Ä Îç∞Ïù¥ÌÑ∞Î•º Í≤ÄÌÜ† Ï§ëÏûÖÎãàÎã§.<br>
                            ÌôïÏù∏Ïù¥ ÏôÑÎ£åÎêòÎ©¥ ÏûêÎèôÏúºÎ°ú Îã§Ïùå Îã®Í≥ÑÎ°ú ÎÑòÏñ¥Í∞ëÎãàÎã§.
                        </div>
                        
                        <div style="text-align: center; padding: 40px; background: white; border-radius: 12px;">
                            <div style="font-size: 60px; margin-bottom: 15px;">‚è∞</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px;">
                                Îç∞Ïù¥ÌÑ∞ Í≤ÄÌÜ† Ï§ë
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                Î≥¥ÌÜµ 1-2Ïùº Ïù¥ÎÇ¥Ïóê ÌôïÏù∏Ïù¥ ÏôÑÎ£åÎê©ÎãàÎã§.
                            </div>
                        </div>
                        
                        <p style="font-size: 13px; color: #666; margin-top: 15px; text-align: center;">
                            üí¨ Î¨∏ÏùòÏÇ¨Ìï≠Ïù¥ ÏûàÏúºÏãúÎ©¥ Ïä¨Îûô Ï±ÑÎÑêÏóê ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî.
                        </p>
                    `
                : "",
          },
          {
            state:
              currentStep > 8 ? "completed" : currentStep === 8 ? "active" : "",
            title: "8Îã®Í≥Ñ: Í∏∞Í∏∞ Î∞òÎÇ© Ï§ÄÎπÑ",
            description: `Îç∞Ïù¥ÌÑ∞ Ï∏°Ï†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!${
              data.pickupDate && data.pickupDate !== "Ï°∞Ïú® Ï§ë"
                ? "<br><strong>ÌöåÏàò ÏòàÏ†ïÏùº: " + data.pickupDate + "</strong>"
                : "<br>Í≥ß ÌÉùÎ∞∞ ÌöåÏàò ÏùºÏ†ïÏùÑ ÏïàÎÇ¥Ìï¥ÎìúÎ¶ΩÎãàÎã§."
            }`,
            content:
              currentStep === 5
                ? `
                        <div class="checklist">
                            <div class="checklist-item">
                                <input type="checkbox" id="check-packed">
                                <label for="check-packed">Ïä§ÎßàÌä∏ÏõåÏπòÏôÄ Ï∂©Ï†ÑÍ∏∞Î•º Î∞ïÏä§Ïóê Îã¥ÏïòÏäµÎãàÎã§</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check-ready">
                                <label for="check-ready">ÌÉùÎ∞∞ Í∏∞ÏÇ¨Îãò Î∞©Î¨∏ Ï§ÄÎπÑ ÏôÑÎ£å</label>
                            </div>
                        </div>
                    `
                : "",
          },
          {
            state: currentStep >= 9 ? "completed" : "",
            title: "ÏôÑÎ£å! üéâ",
            description:
              "Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÌîÑÎ°úÏ†ùÌä∏Ïóê Ï∞∏Ïó¨Ìï¥Ï£ºÏÖîÏÑú Í∞êÏÇ¨Ìï©ÎãàÎã§!<br>Í∑ÄÌïòÏùò Îç∞Ïù¥ÌÑ∞Îäî ÏàòÎ©¥ Ïó∞Íµ¨Ïóê ÌÅ∞ ÎèÑÏõÄÏù¥ Îê† Í≤ÉÏûÖÎãàÎã§.",
            content:
              currentStep >= 9
                ? `
                        <div class="alert alert-success">
                            ‚úÖ Î™®Îì† Îã®Í≥ÑÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. ÏÜåÏ†ïÏùò Ï∞∏Í∞ÄÎπÑÎäî 2-3Ïùº ÎÇ¥Î°ú ÏßÄÍ∏âÎê©ÎãàÎã§.
                        </div>
                    `
                : "",
          },
        ];
      }

      // ===== Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ Ï≤òÎ¶¨ =====
      async function handleDataCheck(answer) {
        if (!currentUser) return;

        if (answer === "no") {
          alert(
            "‚ùå Îç∞Ïù¥ÌÑ∞ Í∏∞Î°ùÏóê Î¨∏Ï†úÍ∞Ä ÏûàÎäî Í≤É Í∞ôÏäµÎãàÎã§.\nÏä¨Îûô Ï±ÑÎÑêÏóê Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.\n\nÍ∏âÌïú Í≤ΩÏö∞: 010-4343-4195"
          );
          return;
        }

        if (!confirm("Ïï±Ïóê Îç∞Ïù¥ÌÑ∞Í∞Ä 4Îã®Í≥ÑÎ°ú Ï†ïÏÉÅ Í∏∞Î°ùÎêú Í≤ÉÏùÑ ÌôïÏù∏ÌïòÏÖ®ÎÇòÏöî?")) {
          return;
        }

        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "updateStatus",
              id: currentUser.id,
              status: "Îç∞Ïù¥ÌÑ∞ÌôïÏù∏ÏôÑÎ£å",
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert(
              "‚úÖ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Ïù¥Ï†ú Îç∞Ïù¥ÌÑ∞Î•º Ï†úÏ∂úÌï¥Ï£ºÏÑ∏Ïöî."
            );
            await refreshData();
          } else {
            alert("‚ùå ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: " + result.message);
          }
        } catch (error) {
          alert("‚ùå ÏÑúÎ≤ÑÏôÄ ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
          console.error(error);
        }
      }

      // ===== ÏÉÅÌÉúÎ≥Ñ Îã®Í≥Ñ Î≤àÌò∏ =====
      function getStepNumber(status) {
        const steps = {
          ÎåÄÍ∏∞Ï§ë: 1,
          Ïä¨ÎûôÏ∞∏Ïó¨: 1,
          Î∞úÏÜ°ÏôÑÎ£å: 2,
          ÏàòÎ†πÌôïÏù∏ÌïÑÏöî: 2,
          ÏàòÎ†πÏôÑÎ£å: 3,
          Ïó∞ÎèôÎåÄÍ∏∞: 3,
          ÏàòÏßëÏ§ë: 4,
          ÏàòÏßëÏôÑÎ£å: 5,
          Îç∞Ïù¥ÌÑ∞ÌôïÏù∏ÏôÑÎ£å: 6,
          Îç∞Ïù¥ÌÑ∞Ï†úÏ∂úÏôÑÎ£å: 7,
          Îß§ÎãàÏ†ÄÌôïÏù∏ÏôÑÎ£å: 8,
          ÌöåÏàòÎåÄÍ∏∞: 8,
          ÌöåÏàòÏôÑÎ£å: 9,
        };
        return steps[status] || 1;
      }

      // ===== ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ =====
      async function updateStatus(newStatus) {
        if (!currentUser) return;

        // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÌôïÏù∏
        if (!validateChecklist(newStatus)) {
          alert("‚úã Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏Î•º Î™®Îëê ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî.");
          return;
        }

        if (!confirm(`ÏÉÅÌÉúÎ•º '${newStatus}'Î°ú Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
          return;
        }

        // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        const buttons = document.querySelectorAll(".btn");
        buttons.forEach((btn) => (btn.disabled = true));

        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "updateStatus",
              id: currentUser.id,
              status: newStatus,
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert("‚úÖ ÏÉÅÌÉúÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!");
            // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
            await refreshData();
          } else {
            alert("‚ùå ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: " + result.message);
          }
        } catch (error) {
          alert("‚ùå ÏÑúÎ≤ÑÏôÄ ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
          console.error(error);
        } finally {
          buttons.forEach((btn) => (btn.disabled = false));
        }
      }

      // ===== Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® =====
      async function refreshData() {
        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "getParticipant",
              id: currentUser.id,
              name: currentUser.name,
            }),
          });

          const result = await response.json();
          if (result.success) {
            currentUser = result.data;
            showProgress(result.data);
          }
        } catch (error) {
          console.error(error);
        }
      }

      // ===== Ï∏°Ï†ïÏùº ÏóÖÎç∞Ïù¥Ìä∏ =====
      async function updateMeasureDate() {
        if (!currentUser) return;

        const dateInput = document.getElementById("measure-date");
        const selectedDate = dateInput.value;

        if (!selectedDate) {
          alert("üìÖ Ï∏°Ï†ï ÏòàÏ†ïÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
          return;
        }

        if (!confirm(`Ï∏°Ï†ï ÏòàÏ†ïÏùºÏùÑ ${selectedDate}Î°ú ÏÑ§Ï†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
          return;
        }

        try {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "updateMeasureDate",
              id: currentUser.id,
              date: selectedDate,
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert("‚úÖ Ï∏°Ï†ï ÏòàÏ†ïÏùºÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§!");
            await refreshData();
          } else {
            alert("‚ùå ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: " + result.message);
          }
        } catch (error) {
          alert("‚ùå ÏÑúÎ≤ÑÏôÄ ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
          console.error(error);
        }
      }

      // ===== Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Í≤ÄÏ¶ù =====
      function validateChecklist(status) {
        if (status === "ÏàòÎ†πÏôÑÎ£å") {
          const check1 = document.getElementById("check-received");
          const check2 = document.getElementById("check-contents");
          return check1 && check2 && check1.checked && check2.checked;
        }
        if (status === "ÏàòÏßëÏ§ë") {
          const check1 = document.getElementById("check-app-install");
          const check2 = document.getElementById("check-device-sync");
          const check3 = document.getElementById("check-data-visible");
          return (
            check1 &&
            check2 &&
            check3 &&
            check1.checked &&
            check2.checked &&
            check3.checked
          );
        }
        if (status === "Îç∞Ïù¥ÌÑ∞Ï†úÏ∂úÏôÑÎ£å") {
          const check1 = document.getElementById("check-guide-read");
          const check2 = document.getElementById("check-data-submitted");
          return check1 && check2 && check1.checked && check2.checked;
        }
        return true;
      }

      // ===== Í∞ÄÏù¥Îìú Ïó¥Í∏∞ =====
      function openGuide(type) {
        // Ïã§Ï†ú Í∞ÄÏù¥Îìú Î¨∏ÏÑú ÎßÅÌÅ¨Î°ú Î≥ÄÍ≤Ω
        const guides = {
          app: "https://docs.google.com/presentation/d/1UvG6Vl1lWJlcOITc3KmaJboFYnmo1FDiJ-nk9qrsrH8/edit?slide=id.g37e30063af9_0_89#slide=id.g37e30063af9_0_89",
          check:
            "https://docs.google.com/presentation/d/1UvG6Vl1lWJlcOITc3KmaJboFYnmo1FDiJ-nk9qrsrH8/edit?slide=id.g37e30063af9_0_231#slide=id.g37e30063af9_0_231",
        };
        if (guides[type]) {
          window.open(guides[type], "_blank");
        }
      }

      // ===== ÏÉÅÌÉúÎ≥Ñ ÏÉâÏÉÅ =====
      function getStatusColor(status) {
        const colors = {
          ÎåÄÍ∏∞Ï§ë: "#6c757d",
          Ïä¨ÎûôÏ∞∏Ïó¨: "#2196f3",
          Î∞úÏÜ°ÏôÑÎ£å: "#ffa500",
          ÏàòÎ†πÏôÑÎ£å: "#2196f3",
          Ïó∞ÎèôÎåÄÍ∏∞: "#ff6b6b",
          ÏàòÏßëÏ§ë: "#4caf50",
          ÏàòÏßëÏôÑÎ£å: "#4caf50",
          Îç∞Ïù¥ÌÑ∞ÌôïÏù∏ÏôÑÎ£å: "#2196f3",
          Îç∞Ïù¥ÌÑ∞Ï†úÏ∂úÏôÑÎ£å: "#667eea",
          Îß§ÎãàÏ†ÄÌôïÏù∏ÏôÑÎ£å: "#4caf50",
        };
        return colors[status] || "#6c757d";
      }

      // ===== ÏóêÎü¨ ÌëúÏãú =====
      function showError(elementId, message) {
        const errorDiv = document.getElementById(elementId);
        errorDiv.textContent = "‚ùå " + message;
        errorDiv.style.display = "block";
      }

      // ===== Î°úÍ∑∏ÏïÑÏõÉ =====
      function logout() {
        currentUser = null;
        document.getElementById("login-card").style.display = "block";
        document.getElementById("progress-card").style.display = "none";
        document.getElementById("participant-id").value = "";
        document.getElementById("participant-name").value = "";
      }

      // ===== URL ÌååÎùºÎØ∏ÌÑ∞ ÏûêÎèô Î°úÍ∑∏Ïù∏ =====
      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");
        const name = urlParams.get("name");

        if (id && name) {
          document.getElementById("participant-id").value = id;
          document.getElementById("participant-name").value = name;
          // ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏõêÌïòÎ©¥ login() Ìò∏Ï∂ú
        }
      };
    </script>
  </body>
</html>
